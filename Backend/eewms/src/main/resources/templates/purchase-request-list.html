<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragments/common-head :: commonHead('Danh s√°ch y√™u c·∫ßu mua h√†ng')}"></head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <main id="mainContent" class="flex-1 ml-64 transition-all duration-300 relative">
        <div th:replace="~{fragments/header :: header}"></div>

        <section class="p-6">
            <div class="mb-6 flex items-center justify-between">
                <h1 class="text-2xl font-bold">Danh s√°ch y√™u c·∫ßu mua h√†ng</h1>

                <form sec:authorize="hasAnyRole('MANAGER','STAFF')"
                      th:action="@{/admin/purchase-requests/generate-all}" method="post" class="inline">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <a class="bg-blue-600 text-white px-4 py-2 rounded"
                       th:href="@{/admin/purchase-requests/collect}">
                        + T·∫°o y√™u c·∫ßu mua
                    </a>
                </form>
            </div>

            <!-- B·ªô l·ªçc (gi·ªëng SO: 1 form, double-click L·ªçc ƒë·ªÉ reset) -->
            <form id="filterForm" method="get" class="mb-6 flex flex-wrap items-center gap-3">
                <input type="text" name="keyword" placeholder="T√¨m theo m√£ ho·∫∑c ng∆∞·ªùi t·∫°o"
                       th:value="${keyword}" class="border px-3 py-2 rounded w-72"/>

                <input type="text" name="creator" placeholder="Ng∆∞·ªùi t·∫°o"
                       th:value="${creator}" class="border px-3 py-2 rounded"/>

                <div class="flex items-center gap-2">
                    <input type="date" name="startDate" th:value="${startDate}" class="border px-3 py-2 rounded"/>
                    <span>‚Äì</span>
                    <input type="date" name="endDate" th:value="${endDate}" class="border px-3 py-2 rounded"/>
                </div>

                <button type="submit" id="btnFilter"
                        class="bg-blue-600 text-white px-4 py-2 rounded"
                        title="Nh·∫•n l·∫°i l·∫ßn n·ªØa v·ªõi b·ªô l·ªçc y h·ªát ƒë·ªÉ x√≥a l·ªçc">L·ªçc</button>
            </form>

            <!-- Th√¥ng b√°o -->
            <div th:if="${message}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-2 rounded mb-4">
                <i class="ri-check-line mr-1"></i><span th:text="${message}"></span>
            </div>
            <div th:if="${error}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4">
                <i class="ri-error-warning-line mr-1"></i><span th:text="${error}"></span>
            </div>

            <!-- Danh s√°ch -->
            <div th:if="${requestPage.totalElements == 0}" class="text-gray-500 italic">Kh√¥ng c√≥ y√™u c·∫ßu n√†o.</div>

            <div th:if="${requestPage.totalElements > 0}">
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table id="Table" class="min-w-full table-auto text-sm border border-gray-200">
                        <thead class="bg-gray-100 text-left">
                        <tr>
                            <th class="px-4 py-3 border border-gray-200 font-semibold whitespace-nowrap">M√£ y√™u c·∫ßu</th>
                            <th class="px-4 py-3 border border-gray-200 font-semibold whitespace-nowrap">Ng∆∞·ªùi t·∫°o</th>
                            <th class="px-4 py-3 border border-gray-200 font-semibold whitespace-nowrap">Ng√†y t·∫°o</th>
                            <th class="px-4 py-3 border border-gray-200 font-semibold whitespace-nowrap text-center">Tr·∫°ng th√°i</th>
                            <th class="px-4 py-3 border border-gray-200 font-semibold whitespace-nowrap text-center">H√†nh ƒë·ªông</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="request : ${requestPage.content}"
                            class="border-t hover:bg-gray-50"
                            th:attr="data-od=${request.createdAt != null ? #temporals.format(request.createdAt, 'yyyyMMddHHmmss') : '00000000000000'},
                                     data-id=${request.id}">
                            <td class="px-4 py-2 border border-gray-200" th:text="${request.code}">PR00001</td>
                            <td class="px-4 py-2 border border-gray-200" th:text="${request.createdByName}">Nguy·ªÖn VƒÉn A</td>
                            <td class="px-4 py-2 border border-gray-200 whitespace-nowrap">
                                <span th:if="${request.createdAt != null}"
                                      th:text="${#temporals.format(request.createdAt, 'dd/MM/yyyy HH:mm')}">01/08/2025</span>
                                <span th:if="${request.createdAt == null}">---</span>
                            </td>

                            <!-- Badge tr·∫°ng th√°i -->
                            <td class="px-4 py-2 border border-gray-200 text-center w-32">
                                <span class="inline-flex items-center justify-center px-2 py-1 rounded text-md font-semibold whitespace-nowrap w-32"
                                      th:classappend="
                                        ${request.status?.name() == 'MOI_TAO'}  ? 'bg-gray-100  text-gray-700'  :
                                        (${request.status?.name() == 'DA_DUYET'} ? 'bg-amber-100 text-amber-700' :
                                        (${request.status?.name() == 'DA_TAO_PO'} ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'))"
                                      th:text="${request.status != null ? request.status.label : '---'}">
                                </span>
                            </td>

                            <!-- Thao t√°c -->
                            <td class="px-4 py-2 border border-gray-200 text-center w-1">
                                <div class="inline-flex items-center gap-2">
                                    <a th:href="@{'/admin/purchase-requests/' + ${request.id}}"
                                       class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-100 text-gray-800 border rounded hover:bg-gray-200 whitespace-nowrap shadow">
                                        <i class="ri-eye-line text-sm"></i> Chi ti·∫øt
                                    </a>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- üîΩ Sort m·ªõi ‚Üí c≈© + x·ª≠ l√Ω L·ªçc l·∫ßn 2 = reset (gi·ªëng SO, KEY ri√™ng) -->
                <script>
                    // --- S·∫ÆP X·∫æP: m·ªõi ‚Üí c≈© (theo data-od) + tie-break theo data-id
                    (function () {
                        var tbody = document.querySelector('#Table tbody');
                        if (!tbody) return;

                        var rows = Array.from(tbody.querySelectorAll('tr[data-od]'));
                        if (!rows.length) return;

                        rows.sort(function (a, b) {
                            var ao = a.dataset.od || '0';
                            var bo = b.dataset.od || '0';
                            if (ao !== bo) return bo.localeCompare(ao); // desc theo th·ªùi gian

                            var ai = parseInt(a.dataset.id || '0', 10);
                            var bi = parseInt(b.dataset.id || '0', 10);
                            if (!isNaN(ai) && !isNaN(bi)) return bi - ai; // desc theo id
                            return (b.dataset.id || '').localeCompare(a.dataset.id || '');
                        });

                        rows.forEach(function (r) { tbody.appendChild(r); });
                    })();

                    // --- L·ªåC L·∫¶N 2 = RESET (sessionStorage)
                    (function () {
                        var form = document.getElementById('filterForm');
                        if (!form) return;

                        var KEY = 'purchaseRequests:lastQuery';

                        function buildNormalizedQuery() {
                            var fd = new FormData(form);
                            var params = new URLSearchParams();

                            ['keyword', 'creator', 'startDate', 'endDate'].forEach(function (n) {
                                var v = (fd.get(n) || '').toString().trim();
                                if (v) params.set(n, v);
                            });

                            return params.toString(); // ch·ªâ ch·ª©a tham s·ªë c√≥ gi√° tr·ªã
                        }

                        form.addEventListener('submit', function (e) {
                            var current = buildNormalizedQuery();
                            var last = sessionStorage.getItem(KEY);

                            if (last && last === current) {
                                e.preventDefault(); // ch·∫∑n submit hi·ªán t·∫°i

                                // X√≥a gi√° tr·ªã input
                                ['keyword', 'creator', 'startDate', 'endDate'].forEach(function (n) {
                                    var el = form.querySelector('[name="' + n + '"]');
                                    if (el) el.value = '';
                                });

                                sessionStorage.removeItem(KEY);

                                // Submit l·∫°i kh√¥ng k√®m tham s·ªë r·ªóng
                                form.querySelectorAll('input,select').forEach(function (el) {
                                    if (!el.value) el.disabled = true;
                                });
                                form.submit();
                            } else {
                                sessionStorage.setItem(KEY, current);
                            }
                        });

                        // (T√πy ch·ªçn) n·∫øu c√≥ n√∫t reset ri√™ng id="btnReset", h·ªó tr·ª£ lu√¥n
                        var resetBtn = document.getElementById('btnReset');
                        if (resetBtn) {
                            resetBtn.addEventListener('click', function () {
                                sessionStorage.removeItem(KEY);
                                var base = form.getAttribute('action') || window.location.pathname;
                                window.location.href = base;
                            });
                        }
                    })();
                </script>

                <div th:replace="~{fragments/pagination :: clientPager('Table', 10)}"></div>
            </div>
        </section>
    </main>
</div>
<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
