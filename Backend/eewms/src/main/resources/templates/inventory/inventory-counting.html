<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{fragments/common-head :: commonHead('Kiểm kê – Nhập số lượng')}"></head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- Main -->
    <main id="mainContent" class="flex-1 ml-64 transition-all duration-300 relative">
        <!-- Header -->
        <div th:replace="~{fragments/header :: header}"></div>

        <section class="p-6 space-y-4">
            <!-- Title / Meta -->
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                    <h2 class="text-xl font-semibold">Kiểm kê – Nhập số lượng</h2>
                    <p class="text-gray-500 text-sm">
                        Mã phiếu:
                        <span class="font-mono bg-gray-100 px-2 py-0.5 rounded"
                              th:text="${count.code}">INV-XXXX</span>
                        <span class="mx-2">•</span>
                        Kho: <strong th:text="${count.warehouseName}">Kho A</strong>
                        <span class="mx-2">•</span>
                        Staff: <strong th:text="${count.staffName}">Nguyễn Văn A</strong>
                    </p>
                </div>
                <!-- Error Box (ẩn mặc định, JS sẽ hiện ra) -->
                <div class="flex items-center gap-2">
                    <!-- Error Box nằm cạnh nút -->
                    <div id="errorBox"
                         style="display:none"
                         class="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded">
                    </div>

                    <button type="button" onclick="window.history.back()"
                            class="px-3 py-2 rounded border bg-white hover:bg-gray-50">
                        Quay lại
                    </button>
                </div>
            </div>
            <div class="ml-auto text-sm text-gray-500">
                <span class="inline-block px-2 py-0.5 rounded bg-red-100 text-red-700">Thiếu</span>
                <span class="inline-block px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 ml-1">Thừa</span>
            </div>
            <!-- Form -->
            <form th:action="@{'/inventory/count/' + ${count.id} + '/submit'}" method="post" id="countForm">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-100">
                            <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">#</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Mã</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Tên sản phẩm</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Tồn hệ thống</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Thực đếm</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Chênh lệch</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Ghi chú</th>
                            </tr>
                            </thead>
                            <tbody id="countBody" class="divide-y divide-gray-100 text-sm">
                            <tr th:each="item,iterStat : ${count.items}" th:data-code="${item.productCode}">
                                <td class="px-4 py-2" th:text="${iterStat.count}">1</td>
                                <td class="px-4 py-2 font-mono" th:text="${item.productCode}">PRD-0001</td>
                                <td class="px-4 py-2" th:text="${item.productName}">Tên SP</td>
                                <td class="px-4 py-2 text-right">
                                    <span class="expected" th:text="${item.expectedQty}">0</span>
                                </td>
                                <td class="px-4 py-2 text-right">
                                    <input type="number" min="0" step="1"
                                           th:value="${item.countedQty}"
                                           name="countedQtys"
                                           class="counted w-24 text-right rounded-lg border-gray-300 px-2 py-1">
                                </td>
                                <td class="px-4 py-2 text-right">
                                    <span class="delta"
                                          th:text="${item.variance}">0</span>
                                </td>
                                <td class="px-4 py-2">
                                    <input type="text" name="notes"
                                           th:value="${item.note}"
                                           class="note w-full rounded-lg border-gray-300 px-2 py-1"
                                           placeholder="Ghi chú…">
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Footer bar -->
                    <div class="flex items-center justify-between px-4 py-3 bg-gray-50">
                        <div class="text-sm text-gray-600">
                            <span>Tổng dòng: <strong id="ftLines">0</strong></span>
                            <span class="mx-2">•</span>
                            <span>Đã nhập: <strong id="ftFilled">0</strong></span>
                            <span class="mx-2">•</span>
                            <span>Chênh lệch tổng: <strong id="ftDelta">0</strong></span>
                        </div>
                    </div>
                </div>

                <!-- Action buttons -->
                <div class="flex justify-end gap-2 mt-4">
                    <button type="submit"
                            th:formaction="@{'/inventory/count/' + ${count.id} + '/draft'}"
                            class="px-3 py-2 rounded border border-amber-600 text-amber-700 hover:bg-amber-50">
                        <i class="ri-save-3-line mr-1"></i>Lưu nháp
                    </button>
                    <button type="submit"
                            th:formaction="@{'/inventory/count/' + ${count.id} + '/submit'}"
                            id="btnSubmit"
                            class="px-4 py-2 rounded-lg border border-emerald-600 text-emerald-700 hover:bg-emerald-50">
                        <i class="ri-check-line mr-1"></i>Nộp kết quả
                    </button>
                </div>
            </form>
        </section>

        <div th:replace="~{fragments/footer :: footer}"></div>
    </main>
</div>

<script>
    (function () {
        const body = document.getElementById('countBody');
        const lines = () => Array.from(body.querySelectorAll('tr'));
        const fmtInt = v => isNaN(v) ? 0 : parseInt(v, 10);

        function recalc() {
            let totalLines = 0, filled = 0, totalDelta = 0;
            lines().forEach(tr => {
                totalLines++;
                const expected = fmtInt(tr.querySelector('.expected').textContent.trim());
                const countedEl = tr.querySelector('.counted');
                const deltaEl = tr.querySelector('.delta');
                const counted = fmtInt(countedEl.value);
                if (countedEl.value !== '' && !isNaN(counted)) filled++;
                const delta = (countedEl.value === '' ? 0 : counted - expected);
                deltaEl.textContent = delta;
                tr.classList.toggle('bg-red-50', delta < 0);
                tr.classList.toggle('bg-emerald-50', delta > 0);
                if (countedEl.value !== '' && !isNaN(counted)) totalDelta += delta;
            });
            document.getElementById('ftLines').textContent = totalLines;
            document.getElementById('ftFilled').textContent = filled;
            document.getElementById('ftDelta').textContent = totalDelta;
        }

        body.addEventListener('input', function (e) {
            if (e.target.classList.contains('counted')) recalc();
        });

        recalc();

        const form = document.getElementById("countForm");
        const btnSubmit = document.getElementById("btnSubmit");

        btnSubmit.addEventListener("click", function (e) {
            const inputs = form.querySelectorAll("input[name='countedQtys']");
            let allFilled = true;
            let firstEmpty = null;

            inputs.forEach((input, idx) => {
                if (input.value.trim() === "") {
                    allFilled = false;
                    input.classList.add("border-red-500"); // highlight ô trống
                    if (!firstEmpty) firstEmpty = idx + 1; // lưu dòng đầu tiên bị thiếu
                } else {
                    input.classList.remove("border-red-500");
                }
            });

            if (!allFilled) {
                e.preventDefault(); // chặn submit

                const errorBox = document.getElementById("errorBox");
                errorBox.style.display = "block";
                errorBox.textContent =
                    "Cần nhập ít nhất 1 số (thiếu ở dòng " + firstEmpty + ")";
            }
        });
    })();
</script>
</body>
</html>
