<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/common-head :: commonHead('Kiểm kê – Review & Approve')}"></head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- Main -->
    <main id="mainContent" class="flex-1 ml-64 transition-all duration-300 relative">
        <!-- Header -->
        <div th:replace="~{fragments/header :: header}"></div>

        <section class="p-6 space-y-4">
            <!-- Title / Meta -->
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                    <h2 class="text-xl font-semibold">Review & Approve – Phiếu kiểm kê</h2>
                    <p class="text-gray-500 text-sm">
                        Mã phiếu: <span class="font-mono bg-gray-100 px-2 py-0.5 rounded">INV-202509-0002</span>
                        <span class="mx-2">•</span>
                        Kho: <strong>Kho B</strong>
                        <span class="mx-2">•</span>
                        Staff: <strong>Trần Thị B</strong>
                        <span class="mx-2">•</span>
                        Trạng thái: <span class="inline-flex px-2 py-0.5 rounded-full bg-amber-100 text-amber-700">Review</span>
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" onclick="window.history.back()"
                            class="px-3 py-2 rounded border bg-white hover:bg-gray-50">
                        Quay lại
                    </button>
                    <button id="btnExport" type="button"
                            class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">
                        <i class="ri-download-2-line mr-1"></i>Export (dummy)
                    </button>
                    <button id="btnApprove" type="button"
                            class="px-4 py-2 rounded-lg border border-emerald-600 text-emerald-700 hover:bg-emerald-50">
                        <i class="ri-check-line mr-1"></i>Duyệt & Tạo điều chỉnh
                    </button>
                </div>
            </div>

            <!-- Summary cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <div class="rounded-2xl border border-gray-100 bg-white p-4">
                    <div class="text-gray-500 text-sm">Tổng dòng</div>
                    <div id="sumLines" class="text-2xl font-semibold">0</div>
                </div>
                <div class="rounded-2xl border border-gray-100 bg-white p-4">
                    <div class="text-gray-500 text-sm">Đã có kết quả</div>
                    <div id="sumFilled" class="text-2xl font-semibold">0</div>
                </div>
                <div class="rounded-2xl border border-gray-100 bg-white p-4">
                    <div class="text-gray-500 text-sm">Tổng chênh lệch</div>
                    <div id="sumDelta" class="text-2xl font-semibold">0</div>
                </div>
                <div class="rounded-2xl border border-gray-100 bg-white p-4">
                    <div class="text-gray-500 text-sm">Số dòng vượt ngưỡng</div>
                    <div id="sumOver" class="text-2xl font-semibold">0</div>
                </div>
            </div>

            <!-- Threshold & actions -->
            <div class="rounded-2xl border border-gray-100 bg-white p-4">
                <div class="flex flex-wrap items-center gap-3">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">Ngưỡng cảnh báo (đơn vị):</label>
                        <input id="threshold" type="number" step="1" min="0" class="w-24 rounded-lg border-gray-300 px-2 py-1" value="2">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">Ngưỡng % (trên tồn hệ thống):</label>
                        <input id="thresholdPct" type="number" step="1" min="0" class="w-24 rounded-lg border-gray-300 px-2 py-1" value="5">
                        <span class="text-sm text-gray-400">(Áp dụng max(|delta|, %))</span>
                    </div>
                    <button id="btnRecalc" type="button"
                            class="px-3 py-2 rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50">
                        <i class="ri-restart-line mr-1"></i>Tính lại
                    </button>
                    <div class="ml-auto text-sm text-gray-500">
                        <span class="inline-block px-2 py-0.5 rounded bg-red-100 text-red-700">Thiếu</span>
                        <span class="inline-block px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 ml-1">Thừa</span>
                        <span class="inline-block px-2 py-0.5 rounded bg-amber-100 text-amber-700 ml-1">Vượt ngưỡng</span>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">#</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Mã</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Tên sản phẩm</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Tồn hệ thống</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Thực đếm</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Chênh lệch</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Ghi chú</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Hành động</th>
                        </tr>
                        </thead>
                        <tbody id="reviewBody" class="divide-y divide-gray-100 text-sm">
                        <!-- DUMMY ROWS (đồng bộ với counting page ví dụ) -->
                        <tr data-code="PRD-0001">
                            <td class="px-4 py-2">1</td>
                            <td class="px-4 py-2 font-mono">PRD-0001</td>
                            <td class="px-4 py-2">CB tép 1P 6A</td>
                            <td class="px-4 py-2 text-right"><span class="expected">120</span></td>
                            <td class="px-4 py-2 text-right"><span class="counted">118</span></td>
                            <td class="px-4 py-2 text-right"><span class="delta">-2</span></td>
                            <td class="px-4 py-2">Móp hộp, loại 2 sp</td>
                            <td class="px-4 py-2 text-right">
                                <button class="btnRecount px-3 py-1.5 rounded-lg border border-amber-600 text-amber-700 hover:bg-amber-50">
                                    Yêu cầu đếm lại
                                </button>
                            </td>
                        </tr>
                        <tr data-code="PRD-0002">
                            <td class="px-4 py-2">2</td>
                            <td class="px-4 py-2 font-mono">PRD-0002</td>
                            <td class="px-4 py-2">CB tép 1P 10A</td>
                            <td class="px-4 py-2 text-right"><span class="expected">75</span></td>
                            <td class="px-4 py-2 text-right"><span class="counted">80</span></td>
                            <td class="px-4 py-2 text-right"><span class="delta">5</span></td>
                            <td class="px-4 py-2">Nhập ký gửi chưa ghi nhận</td>
                            <td class="px-4 py-2 text-right">
                                <button class="btnRecount px-3 py-1.5 rounded-lg border border-amber-600 text-amber-700 hover:bg-amber-50">
                                    Yêu cầu đếm lại
                                </button>
                            </td>
                        </tr>
                        <tr data-code="PRD-0101">
                            <td class="px-4 py-2">3</td>
                            <td class="px-4 py-2 font-mono">PRD-0101</td>
                            <td class="px-4 py-2">Dây điện VCm 2.5</td>
                            <td class="px-4 py-2 text-right"><span class="expected">200</span></td>
                            <td class="px-4 py-2 text-right"><span class="counted">200</span></td>
                            <td class="px-4 py-2 text-right"><span class="delta">0</span></td>
                            <td class="px-4 py-2">OK</td>
                            <td class="px-4 py-2 text-right">
                                <button class="btnRecount px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-gray-50">
                                    Đếm lại (tuỳ chọn)
                                </button>
                            </td>
                        </tr>
                        <!-- /DUMMY ROWS -->
                        </tbody>
                    </table>
                </div>

                <!-- Footer bar -->
                <div class="flex items-center justify-between px-4 py-3 bg-gray-50">
                    <div class="text-sm text-gray-600">
                        <span>Tổng dòng: <strong id="ftLines">0</strong></span>
                        <span class="mx-2">•</span>
                        <span>Đã có kết quả: <strong id="ftFilled">0</strong></span>
                        <span class="mx-2">•</span>
                        <span>Chênh lệch tổng: <strong id="ftDelta">0</strong></span>
                        <span class="mx-2">•</span>
                        <span>Dòng vượt ngưỡng: <strong id="ftOver">0</strong></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">Ghi chú duyệt:</label>
                        <input id="approveNote" type="text" class="w-64 rounded-lg border-gray-300 px-2 py-1" placeholder="Ví dụ: Duyệt tạo điều chỉnh">
                    </div>
                </div>
            </div>
        </section>

        <div th:replace="~{fragments/footer :: footer}"></div>
    </main>
</div>

<script>
    (function () {
        const body = document.getElementById('reviewBody');
        const lines = () => Array.from(body.querySelectorAll('tr'));

        const $ = sel => document.querySelector(sel);
        const getInt = (el) => {
            const v = parseInt((el?.textContent || '0').trim(), 10);
            return Number.isNaN(v) ? 0 : v;
        };

        function isOverThreshold(expected, delta, thrAbs, thrPct) {
            const abs = Math.abs(delta);
            const pct = expected > 0 ? Math.abs(delta) / expected * 100 : (abs > 0 ? 100 : 0);
            return abs >= thrAbs || pct >= thrPct;
        }

        function recalc() {
            const thrAbs = parseInt($('#threshold').value || '0', 10) || 0;
            const thrPct = parseInt($('#thresholdPct').value || '0', 10) || 0;

            let totalLines = 0, filled = 0, totalDelta = 0, over = 0;

            lines().forEach(tr => {
                totalLines++;
                const expected = getInt(tr.querySelector('.expected'));
                const counted  = getInt(tr.querySelector('.counted'));
                const delta    = getInt(tr.querySelector('.delta'));

                // color rows
                tr.classList.toggle('bg-red-50', delta < 0);
                tr.classList.toggle('bg-emerald-50', delta > 0);

                const overFlag = isOverThreshold(expected, delta, thrAbs, thrPct);
                tr.dataset.over = overFlag ? '1' : '0';
                const deltaCell = tr.querySelector('.delta').parentElement;
                deltaCell.classList.toggle('bg-amber-100', overFlag);
                if (overFlag) over++;

                if (!Number.isNaN(counted)) { filled++; totalDelta += delta; }
            });

            // Summary
            $('#sumLines').textContent = totalLines;
            $('#sumFilled').textContent = filled;
            $('#sumDelta').textContent = totalDelta;
            $('#sumOver').textContent  = over;

            $('#ftLines').textContent = totalLines;
            $('#ftFilled').textContent = filled;
            $('#ftDelta').textContent = totalDelta;
            $('#ftOver').textContent  = over;
        }

        // bind
        $('#btnRecalc').addEventListener('click', recalc);
        $('#threshold').addEventListener('input', recalc);
        $('#thresholdPct').addEventListener('input', recalc);

        body.addEventListener('click', function (e) {
            const btn = e.target.closest('.btnRecount');
            if (!btn) return;
            const tr = e.target.closest('tr');
            const code = tr?.dataset?.code || 'UNKNOWN';
            if (typeof toastr !== 'undefined') toastr.info('Đã yêu cầu đếm lại: ' + code + ' (dummy)');
        });

        $('#btnApprove').addEventListener('click', function () {
            const over = lines().filter(tr => tr.dataset.over === '1').length;
            if (over > 0) {
                if (typeof toastr !== 'undefined') toastr.warning('Còn ' + over + ' dòng vượt ngưỡng – cân nhắc đếm lại trước khi duyệt.');
            } else {
                if (typeof toastr !== 'undefined') toastr.success('Đã duyệt & tạo điều chỉnh (dummy).');
            }
        });

        $('#btnExport').addEventListener('click', function () {
            if (typeof toastr !== 'undefined') toastr.info('Xuất báo cáo (dummy).');
        });

        // init
        recalc();
    })();
</script>
</body>
</html>
