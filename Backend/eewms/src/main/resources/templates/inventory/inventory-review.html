<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/common-head :: commonHead('Kiểm kê – Review & Approve')}"></head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- Main -->
    <main id="mainContent" class="flex-1 ml-64 transition-all duration-300 relative">
        <!-- Header -->
        <div th:replace="~{fragments/header :: header}"></div>

        <section class="p-6 space-y-4">
            <!-- Title / Meta -->
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                    <h2 class="text-xl font-semibold">Review & Approve – Phiếu kiểm kê</h2>
                    <p class="text-gray-500 text-sm">
                        Mã phiếu: <span class="font-mono bg-gray-100 px-2 py-0.5 rounded"
                                        th:text="${count.code}"></span>
                        <span class="mx-2">•</span>
                        Kho: <strong th:text="${count.warehouseName}"></strong>
                        <span class="mx-2">•</span>
                        Staff: <strong th:text="${count.staffName}"></strong>
                        <span class="mx-2">•</span>
                        Trạng thái:
                        <span class="inline-flex px-2 py-0.5 rounded-full"
                              th:text="${count.status.label}"></span>
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" onclick="window.history.back()"
                            class="px-3 py-2 rounded border bg-white hover:bg-gray-50">
                        Quay lại
                    </button>
                    <!-- Nếu có chênh lệch -->
                    <form th:if="${#authorization.expression('hasRole(''MANAGER'')')
              and count.status.name() == 'SUBMITTED'
              and count.totalVariance != 0}"
                          th:action="@{'/inventory/count/' + ${count.id} + '/reopen'}"
                          method="post"
                          class="flex items-center gap-2">

                        <input name="approveNote" type="hidden" value="Yêu cầu kiểm lại"/>
                        <button type="submit"
                                class="px-4 py-2 rounded-lg border border-emerald-600 text-emerald-700 hover:bg-emerald-50">
                            <i class="ri-check-line mr-1"></i>Yêu cầu điều chỉnh.
                        </button>
                    </form>

                    <!-- Nếu khớp hoàn toàn -->
                    <form th:if="${#authorization.expression('hasRole(''MANAGER'')')
              and count.status.name() == 'SUBMITTED'
              and count.totalVariance == 0}"
                          th:action="@{'/inventory/count/' + ${count.id} + '/approve'}"
                          method="post"
                          class="flex items-center gap-2">

                        <input name="approveNote" type="hidden" value="Duyệt"/>
                        <button type="submit"
                                class="px-4 py-2 rounded-lg border border-blue-600 text-blue-700 hover:bg-blue-50">
                            <i class="ri-check-line mr-1"></i>Duyệt
                        </button>
                    </form>


                </div>
            </div>

            <!-- Summary cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="rounded-2xl border border-gray-100 bg-white p-4">
                    <div class="text-gray-500 text-sm">Tổng dòng sản phẩm</div>
                    <div id="sumLines" class="text-2xl font-semibold">0</div>
                </div>
                <div class="rounded-2xl border border-gray-100 bg-white p-4">
                    <div class="text-gray-500 text-sm">Tổng chênh lệch</div>
                    <div id="sumDelta" class="text-2xl font-semibold">0</div>
                </div>
                <div class="rounded-2xl border border-gray-100 bg-white p-4">
                    <div class="text-gray-500 text-sm">Số dòng sản phẩm vượt ngưỡng</div>
                    <div id="sumOver" class="text-2xl font-semibold">0</div>
                </div>
            </div>

            <!-- Threshold & actions -->
            <div class="rounded-2xl border border-gray-100 bg-white p-4">
                <div class="flex flex-wrap items-center gap-3">
                    <div class="ml-auto text-sm text-gray-500">
                        <span class="inline-block px-2 py-0.5 rounded bg-red-100 text-red-700">Thiếu</span>
                        <span class="inline-block px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 ml-1">Thừa</span>
                        <span class="inline-block px-2 py-0.5 rounded bg-amber-100 text-amber-700 ml-1">Vượt ngưỡng</span>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">#</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Mã</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Tên sản phẩm</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Tồn hệ thống</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Thực đếm</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Chênh lệch</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Ghi chú</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Hành động</th>
                        </tr>
                        </thead>
                        <tbody id="reviewBody" class="divide-y divide-gray-100 text-sm">
                        <tr th:each="item, iterStat : ${count.items}" th:data-code="${item.productCode}">
                            <td class="px-4 py-2" th:text="${iterStat.index + 1}"></td>
                            <td class="px-4 py-2 font-mono" th:text="${item.productCode}"></td>
                            <td class="px-4 py-2" th:text="${item.productName}"></td>
                            <td class="px-4 py-2 text-right"><span class="expected" th:text="${item.expectedQty}"></span></td>
                            <td class="px-4 py-2 text-right"><span class="counted" th:text="${item.countedQty}"></span></td>
                            <td class="px-4 py-2 text-right"><span class="delta" th:text="${item.variance}"></span></td>
                            <td class="px-4 py-2" th:text="${item.note}"></td>
                            <td class="px-4 py-2 text-right">
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Footer bar -->
                <div class="flex items-center justify-between px-4 py-3 bg-gray-50">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600"></label>
                        <input id="approveNote" type="hidden" class="w-64 rounded-lg border-gray-300 px-2 py-1" placeholder="Ví dụ: Duyệt tạo điều chỉnh">
                    </div>
                </div>
            </div>
        </section>

        <div th:replace="~{fragments/footer :: footer}"></div>
    </main>
</div>

<script>
    (function () {
        const body = document.getElementById('reviewBody');
        if (!body) return; // an toàn nếu template khác tái dùng script

        const $ = sel => document.querySelector(sel);
        const getInt = (el) => {
            if (!el) return 0;
            const v = parseInt((el.textContent || '').trim(), 10);
            return Number.isNaN(v) ? 0 : v;
        };

        function isOverThreshold(expected, delta, thrAbs, thrPct) {
            const abs = Math.abs(delta);
            const pct = expected > 0 ? abs / expected * 100 : (abs > 0 ? 100 : 0);
            return abs >= thrAbs || pct >= thrPct;
        }

        function recalc() {
            // Ngưỡng mặc định
            const thrAbs = 2;
            const thrPct = 5;

            let totalLines = 0, totalDelta = 0, over = 0;

            body.querySelectorAll('tr').forEach(tr => {
                totalLines++;

                const expected = getInt(tr.querySelector('.expected'));
                const counted  = getInt(tr.querySelector('.counted'));
                const delta    = getInt(tr.querySelector('.delta'));

                // tô màu thiếu/thừa
                tr.classList.toggle('bg-red-50', delta < 0);
                tr.classList.toggle('bg-emerald-50', delta > 0);

                // đánh dấu vượt ngưỡng
                const overFlag = isOverThreshold(expected, delta, thrAbs, thrPct);
                tr.dataset.over = overFlag ? '1' : '0';
                const deltaCell = tr.querySelector('.delta')?.parentElement;
                if (deltaCell) deltaCell.classList.toggle('bg-amber-100', overFlag);
                if (overFlag) over++;

                if (!Number.isNaN(delta)) totalDelta += delta;
            });

            // cập nhật các card tổng
            const sumLines = $('#sumLines');
            if (sumLines) sumLines.textContent = String(totalLines);
            const sumDelta = $('#sumDelta');
            if (sumDelta) sumDelta.textContent = String(totalDelta);
            const sumOver  = $('#sumOver');
            if (sumOver)  sumOver.textContent  = String(over);
        }

        // Chỉ giữ listener thực sự tồn tại (không có thì bỏ qua)
        const approveBtn = $('#btnApprove');
        if (approveBtn) {
            approveBtn.addEventListener('click', function () {
                const overCnt = Array.from(body.querySelectorAll('tr'))
                    .filter(tr => tr.dataset.over === '1').length;
                if (overCnt > 0 && typeof toastr !== 'undefined') {
                    toastr.warning('Còn ' + overCnt + ' dòng vượt ngưỡng – cân nhắc đếm lại trước khi duyệt.');
                }
            });
        }
        // init
        recalc();
    })();
</script>
</body>
</html>
