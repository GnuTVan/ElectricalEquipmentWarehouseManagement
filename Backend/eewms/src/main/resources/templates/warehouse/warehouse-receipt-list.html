<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/common-head :: commonHead('Danh s√°ch phi·∫øu nh·∫≠p kho')}"></head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <main id="mainContent" class="flex-1 ml-64 transition-all duration-300 relative">
        <div th:replace="~{fragments/header :: header}"></div>

        <div class="mb-4 px-6 py-6">
            <h1 class="text-2xl font-bold text-gray-800">Danh s√°ch phi·∫øu nh·∫≠p kho</h1>
        </div>

        <div class="px-6" th:if="${message}">
            <div th:text="${message}" th:classappend="${messageType}=='success' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'" class="px-4 py-3 rounded mb-4"></div>
        </div>

        <div class="px-6 pb-6">
            <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                <table id="Table" class="min-w-full table-auto text-sm text-left border border-gray-200">
                    <thead class="bg-gray-100 text-gray-700 font-semibold">
                    <tr>
                        <th class="px-6 py-3 border border-gray-200 whitespace-nowrap">M√£ phi·∫øu</th>
                        <th class="px-6 py-3 border border-gray-200 whitespace-nowrap">ƒê∆°n h√†ng</th>
                        <th class="px-6 py-3 border border-gray-200 whitespace-nowrap">Ng∆∞·ªùi t·∫°o</th>
                        <th class="px-6 py-3 border border-gray-200 whitespace-nowrap">Th·ªùi gian</th>
                        <th class="px-6 py-3 border border-gray-200 whitespace-nowrap">C√¥ng n·ª£</th>
                        <th class="px-4 py-2 border border-gray-200 whitespace-nowrap text-center">H√†nh ƒë·ªông</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- ‚¨áÔ∏è Th√™m data-od (yyyyMMddHHmmss) + data-code ƒë·ªÉ sort -->
                    <tr th:each="r : ${receipts}"
                        class="border-t hover:bg-gray-50 transition"
                        th:attr="data-od=${r.createdAt != null} ? ${#temporals.format(r.createdAt, 'yyyyMMddHHmmss')} : '00000000000000',
                                 data-code=${r.code}">
                        <td class="px-6 py-3 border border-gray-200 font-medium" th:text="${r.code}">RN001</td>
                        <td class="px-6 py-3 border border-gray-200">
                            <!-- N·∫øu c√≥ PO: hi·ªán m√£ PO + link nh∆∞ c≈© -->
                            <span th:if="${r.purchaseOrder != null}">
                                <a th:href="@{'/admin/purchase-orders/' + ${r.purchaseOrder.id}}"
                                   class="text-blue-700 hover:underline"
                                   th:text="${r.purchaseOrder.code}">PO</a>
                            </span>

                            <!-- N·∫øu KH√îNG c√≥ PO (GRN do ho√†n h√†ng): hi·ªán note -->
                            <span th:if="${r.purchaseOrder == null}">
                                <a th:if="${r.requestId != null and #strings.startsWith(r.requestId, 'SR-RECV-')}"
                                   th:href="@{'/admin/sales-returns/' + ${#strings.substring(r.requestId, 8)}}"
                                   class="text-blue-700 hover:underline"
                                   th:text="${#strings.isEmpty(r.note) ? 'H√†ng ho√†n' : r.note}">H√†ng ho√†n</a>
                                <span th:unless="${r.requestId != null and #strings.startsWith(r.requestId, 'SR-RECV-')}"
                                      th:text="${#strings.isEmpty(r.note) ? 'H√†ng ho√†n' : r.note}">H√†ng ho√†n</span>
                            </span>
                        </td>
                        <td class="px-6 py-3 border border-gray-200" th:text="${r.createdBy}">Admin</td>
                        <td class="px-6 py-3 border border-gray-200 whitespace-nowrap"
                            th:text="${#temporals.format(r.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2025</td>

                        <td class="px-6 py-3 border border-gray-200 w-50"
                            th:with="isReturn=${r.requestId != null and #strings.startsWith(r.requestId, 'SR-RECV-')},
                                     canConfirm=${#authorization.expression('hasRole(''MANAGER'')')}">

                            <!-- ƒê√É c√≥ c√¥ng n·ª£ -->
                            <span th:if="${hasDebt[r.id]}"
                                  class="inline-block px-2 py-1 rounded bg-emerald-100 text-emerald-700">ƒê√£ t·∫°o</span>

                            <!-- H√ÄNG HO√ÄN -->
                            <span th:if="${!hasDebt[r.id] and isReturn}"
                                  class="inline-block px-2 py-1 rounded bg-slate-100 text-slate-700">H√†ng ho√†n</span>

                            <!-- GRN t·ª´ PO: MANAGER ƒë∆∞·ª£c t·∫°o c√¥ng n·ª£ -->
                            <form th:if="${!hasDebt[r.id] and !isReturn and canConfirm}"
                                  th:action="@{'/admin/warehouse-receipts/' + ${r.id} + '/confirm'}"
                                  method="post" class="flex items-center gap-2">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <select name="termDays" class="border rounded px-2 py-1">
                                    <option value="0">Thanh to√°n ngay</option>
                                    <option value="7" selected>7 ng√†y</option>
                                    <option value="10">10 ng√†y</option>
                                </select>
                                <button type="submit" class="px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700 whitespace-nowrap shadow">
                                    T·∫°o c√¥ng n·ª£
                                </button>
                            </form>

                            <!-- GRN t·ª´ PO: kh√¥ng ph·∫£i MANAGER -->
                            <span th:if="${!hasDebt[r.id] and !isReturn and !canConfirm}"
                                  class="inline-block px-2 py-1 rounded bg-red-100 text-red-700">Ch∆∞a c√≥ c√¥ng n·ª£</span>
                        </td>

                        <td class="px-4 py-2 border border-gray-200 text-center w-1">
                            <a th:href="@{'/admin/warehouse-receipts/view/' + ${r.id}}"
                               class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-100 text-gray-800 border rounded hover:bg-gray-200 whitespace-nowrap shadow">
                                <i class="ri-eye-line text-sm"></i> Chi ti·∫øt
                            </a>
                        </td>
                    </tr>

                    <!-- Empty state (n·∫øu c·∫ßn) -->
                    <tr th:if="${#lists.isEmpty(receipts)}">
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div th:replace="~{fragments/pagination :: clientPager('Table', 10)}"></div>
        </div>
    </main>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- üîΩ Sort m·ªõi ‚Üí c≈© (gi·ªëng SO) -->
<script>
    (function () {
        const tbody = document.querySelector('#Table tbody');
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr[data-od]'));
        if (!rows.length) return;

        // r√∫t s·ªë t·ª´ m√£ (RN0001 -> 1) ƒë·ªÉ tie-break
        const codeNum = (el) => {
            const raw = (el.dataset.code || '').toString();
            const n = parseInt(raw.replace(/\D/g, ''), 10);
            return isNaN(n) ? 0 : n;
        };

        rows.sort((a, b) => {
            const ao = a.dataset.od || '0';
            const bo = b.dataset.od || '0';
            if (ao !== bo) return bo.localeCompare(ao);  // desc theo th·ªùi gian
            return codeNum(b) - codeNum(a);              // tie-break desc theo s·ªë trong m√£
        });

        rows.forEach(r => tbody.appendChild(r));
    })();
</script>
</body>
</html>
