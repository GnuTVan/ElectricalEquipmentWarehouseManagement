<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/common-head :: commonHead('Danh sách sản phẩm')}">

    <style>
        /* Giữ choices bám theo khung của wrapper, không nở theo option dài */
        .supplier-filter .choices,
        .supplier-filter .choices__inner,
        .supplier-filter .choices__list {
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Căn TRÊN; cho phép nội dung nhiều dòng trong khung đã chọn */
        .supplier-filter .choices__inner {
            display: grid !important;          /* thay inline-block */
            align-content: start !important;   /* căn đỉnh */
            min-height: 2.5rem;                /* ~ h-10 */
            padding: .5rem .75rem;             /* khớp px-3 h-10 */
            line-height: 1.25rem !important;   /* bỏ line-height lớn mặc định */
        }

        /* Text đã chọn: cho phép xuống dòng */
        .supplier-filter .choices__list--single .choices__item,
        .supplier-filter .choices__placeholder {
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: clip !important;
        }

        /* Dropdown cũng wrap, không kéo giãn khung */
        .supplier-filter .choices__list--dropdown {
            width: 100% !important;
            max-width: 100% !important;
        }
        .supplier-filter .choices__list--dropdown .choices__item {
            white-space: normal !important;
        }

        /* Dọn margin/padding để nội dung áp sát trên */
        .supplier-filter .choices__list--single {
            margin: 0 !important;
            padding: 0 !important;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <!-- Sidebar fragment -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>
    <!-- Main Content -->
    <main id="mainContent" class="flex-1 ml-64 transition-all duration-300 relative">
        <!-- Header -->
        <div th:replace="~{fragments/header :: header}"></div>


        <!-- Tiêu đề + Nút Thêm -->
        <div class="flex justify-between items-center mb-4 px-6 py-6">
            <h1 class="text-2xl font-bold">Danh sách sản phẩm</h1>
            <div sec:authorize="hasAnyRole('MANAGER', 'ADMIN')"
                 class="flex gap-2">
                <a onclick="openAddModal()"
                   class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 cursor-pointer">+ Thêm</a>
                <!-- Thanh tìm kiếm nhanh -->
                <form th:action="@{/products}" method="get" class="flex gap-2">
                    <input type="text" name="keyword" th:value="${keyword}"
                           placeholder="Tìm theo tên hoặc mã sản phẩm..." class="border px-3 py-2 rounded-md w-64"/>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tìm
                    </button>
                </form>
            </div>
        </div>

        <!-- Filter Bar (thêm lại) -->
        <div class="px-6">
            <form th:action="@{/products}" method="get" class="mb-4 flex flex-wrap items-center gap-2">
                <input type="text" name="keyword" th:value="${keyword}" placeholder="Mã / Tên SP"
                       class="border rounded w-60 h-10 px-3"/>

                <!-- Nhà cung cấp -->
                <div class="supplier-filter relative w-64 md:w-80 lg:w-[28rem] self-start">
                    <select id="filterSupplierId" name="supplierId" class="w-full">
                        <option value="" th:selected="${supplierId == null}">Nhà cung cấp</option>
                        <option th:each="s : ${suppliers}"
                                th:value="${s.id}"
                                th:text="${s.name}"
                                th:attr="title=${s.name}"
                                th:selected="${supplierId != null and supplierId == s.id}">
                        </option>
                    </select>
                </div>




                <!-- Danh mục -->
                <select name="categoryId" class="border rounded h-10 px-3">
                    <option value="" th:selected="${categoryId == null}">Danh mục</option>
                    <option th:each="c : ${categories}"
                            th:value="${c.id}"
                            th:text="${c.name}"
                            th:selected="${categoryId != null and categoryId == c.id}">
                    </option>
                </select>

                <!-- Thương hiệu -->
                <select name="brandId" class="border rounded h-10 px-3">
                    <option value="" th:selected="${brandId == null}">Thương hiệu</option>
                    <option th:each="b : ${brands}"
                            th:value="${b.id}"
                            th:text="${b.name}"
                            th:selected="${brandId != null and brandId == b.id}">
                    </option>
                </select>

                <!-- Trạng thái (Enum) -->
                <select name="status" class="border rounded h-10 px-3">
                    <option value="" th:selected="${status == null}">Trạng thái</option>
                    <option th:each="st : ${productStatuses}"
                            th:value="${st.name()}"
                            th:text="${st.name()}"
                            th:selected="${status != null and status.name() == st.name()}">
                    </option>
                </select>

                <button type="submit" class="px-4 h-10 bg-blue-600 text-white rounded">Lọc</button>

                <!-- Xóa lọc về trang mặc định -->
                <a th:href="@{/products}" class="px-3 h-10 inline-flex items-center border rounded hover:bg-gray-50">Xóa
                    lọc</a>
            </form>
        </div>

        <!-- Bảng dữ liệu -->
        <div class="px-6 py-6">
            <div class="bg-white rounded-lg shadow">
                <table id="Table" class="min-w-full table-auto text-sm border border-gray-200">
                    <thead class="bg-gray-100 text-left">
                    <tr>
                        <th class="px-4 py-3 whitespace-nowrap border border-gray-200">Mã SP</th>
                        <th class="px-4 py-3 whitespace-nowrap border border-gray-200">Tên</th>
                        <th class="px-4 py-3 whitespace-nowrap border border-gray-200">Ảnh</th>
                        <th class="px-4 py-3 whitespace-nowrap border border-gray-200 text-right">Giá niêm yết</th>
                        <th class="px-4 py-3 whitespace-nowrap hidden">Số lượng</th>
                        <th class="px-4 py-3 whitespace-nowrap border border-gray-200">Thương hiệu</th>
                        <th class="px-4 py-3 whitespace-nowrap border border-gray-200">Danh mục</th>
                        <th class="px-4 py-3 text-center whitespace-nowrap border border-gray-200">Nhà cung cấp</th>
                        <th class="px-4 py-3 text-center whitespace-nowrap border border-gray-200">Trạng thái</th>
                        <th class="px-4 py-3 text-center whitespace-nowrap border border-gray-200">Hành động</th>
                    </tr>

                    </thead>
                    <tbody>
                    <!-- Empty state khi không có kết quả -->
                    <tr th:if="${products == null or #lists.isEmpty(products)}">
                        <td colspan="10" class="px-4 py-6 text-center text-gray-500 italic">
                            Không có sản phẩm phù hợp hiện tại.
                        </td>
                    </tr>

                    <!-- Rows -->
                    <tr th:each="product : ${products}"
                        th:unless="${products == null or #lists.isEmpty(products)}"
                        class="border-t hover:bg-gray-100"
                        th:data-id="${product.id}"
                        th:data-code="${product.code}"
                        th:data-name="${product.name}"
                        th:data-originprice="${product.originPrice}"
                        th:data-listingprice="${product.listingPrice}"
                        th:data-quantity="${product.quantity}"
                        th:data-newqty="${newQtyMap[product.id] != null ? newQtyMap[product.id] : 0}"
                        th:data-returnedqty="${returnedQtyMap[product.id] != null ? returnedQtyMap[product.id] : 0}"
                        th:data-status="${product.status}"
                        th:data-brand="${product.brand.name}"
                        th:data-brand-id="${product.brand.id}"
                        th:data-category="${product.category.name}"
                        th:data-category-id="${product.category.id}"
                        th:data-unit="${product.unit.name}"
                        th:data-unit-id="${product.unit.id}"
                        th:data-description="${product.description}"
                        th:data-images="${#lists.isEmpty(product.images) ? '' : product.images[0].imageUrl}"
                        th:data-supplier-names="${product.supplierNames != null ? #strings.arrayJoin(product.supplierNames, ',') : ''}"
                        th:data-supplier-ids="${product.supplierIds != null ? #strings.arrayJoin(product.supplierIds, ',') : ''}">

                        <td class="px-4 py-3 border border-gray-200" th:text="${product.code}"></td>
                        <td class="px-4 py-3 border border-gray-200" th:text="${product.name}"></td>
                        <td class="px-4 py-3 border border-gray-200">
                            <div th:if="${#lists.isEmpty(product.images)}">
                                <span class="text-gray-500 italic text-center">Không có ảnh</span>
                            </div>
                            <div th:unless="${#lists.isEmpty(product.images)}">
                                <img th:src="${product.images[0].imageUrl}"
                                     alt="Ảnh đại diện"
                                     class="w-20 h-15 object-cover rounded border"/>
                            </div>
                        </td>
                        <td class="px-4 py-3 border border-gray-200 text-right"
                            th:text="${#numbers.formatDecimal(product.listingPrice, 0, 'DEFAULT', 0, 'DEFAULT')}+ ' đ'"></td>

                        <!-- Cột Số lượng -->
                        <td class="hidden px-4 py-3 border border-gray-200">
                            <div class="font-medium" th:text="${product.quantity}">0</div>
                            <div class="text-xs text-gray-500">
                                Mới:
                                <span th:text="${newQtyMap.containsKey(product.id) ? newQtyMap.get(product.id) : 0}">0</span>
                                &nbsp;•&nbsp;
                                Hoàn:
                                <span th:text="${returnedQtyMap.containsKey(product.id) ? returnedQtyMap.get(product.id) : 0}">0</span>
                            </div>
                        </td>

                        <td class="px-4 py-3 border border-gray-200" th:text="${product.brand.name}"></td>
                        <td class="px-4 py-3 border border-gray-200 whitespace-nowrap" th:text="${product.category.name}"></td>
                        <td class="px-4 py-3 border border-gray-200"
                            th:text="${#lists.isEmpty(product.supplierNames) ? '—' : #strings.arrayJoin(product.supplierNames, ', ')}">
                        </td>

                        <!-- Trạng thái -->
                        <td class="px-4 py-3 border border-gray-200">
                            <div class="flex items-center justify-center gap-3">
                                <span data-status-badge
                                      class="inline-flex items-center justify-center w-32 px-2 py-1 rounded text-xs font-medium whitespace-nowrap"
                                      th:classappend="${product.status.name() == 'ACTIVE'} ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                                      th:text="${product.status.name() == 'ACTIVE'} ? 'Đang hoạt động' : 'Ngưng hoạt động'">
</span>
                                <label sec:authorize="hasAnyRole('MANAGER')"
                                       class="inline-flex relative items-center cursor-pointer">
                                    <input type="checkbox"
                                           th:checked="${product.status.name() == 'ACTIVE'}"
                                           th:data-id="${product.id}"
                                           class="sr-only peer"
                                           onchange="toggleStatus(this)">
                                    <div class="w-11 h-6 rounded-full transition-colors duration-300 bg-red-500 peer-checked:bg-green-500"></div>
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 peer-checked:translate-x-5"></div>
                                </label>
                            </div>
                        </td>

                        <!-- Hành động -->
                        <td class="px-4 py-3 border border-gray-200 text-center whitespace-nowrap">
                            <div class="inline-flex items-center gap-2">
                                <a href="#" onclick="openDetailModal(this)"
                                   class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-100 text-gray-800 border rounded hover:bg-gray-200 whitespace-nowrap shadow">
                                    <i class="ri-eye-line text-sm"></i> Chi tiết
                                </a>
                                <a sec:authorize="hasAnyRole('MANAGER')"
                                   href="#" onclick="openEditModal(this)"
                                   class="inline-flex items-center gap-1 px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded shadow">
                                    <i class="ri-pencil-line text-sm"></i> Sửa
                                </a>
                                <a th:href="@{|/inventory/products/${product.id}/stock|}"
                                   class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-100 text-gray-800 border rounded hover:bg-gray-200 shadow">
                                    <i class="ri-warehouse-line text-sm"></i> Tồn theo kho
                                </a>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div th:replace="~{fragments/pagination :: clientPager('Table', 10)}"></div>
        </div>

        <!-- Modal Chi tiết sản phẩm -->
        <div id="detailProductModal" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/40"></div>

            <!-- Panel -->
            <div class="relative mx-auto my-10 w-full max-w-3xl">
                <div class="bg-white rounded-xl shadow-xl overflow-hidden">
                    <!-- Header -->
                    <div class="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
                        <h2 class="text-lg font-semibold">Chi tiết sản phẩm</h2>
                        <button onclick="closeDetailModal()" class="p-2 rounded hover:bg-gray-100" aria-label="Đóng">
                            <i class="ri-close-line text-2xl"></i>
                        </button>
                    </div>

                    <!-- Body -->
                    <div class="px-6 py-5 max-h-[70vh] overflow-auto">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="text-gray-500">Mã SP</span>
                                <div class="font-medium" id="d_code"></div>
                            </div>
                            <div><span class="text-gray-500">Tên</span>
                                <div class="font-medium" id="d_name"></div>
                            </div>
                            <div><span class="text-gray-500">Giá gốc</span>
                                <div class="font-medium" id="d_originPrice"></div>
                            </div>
                            <div><span class="text-gray-500">Giá niêm yết</span>
                                <div class="font-medium" id="d_listingPrice"></div>
                            </div>
                            <div class="hidden"><span class="text-gray-500">Số lượng</span>
                                <div class="font-medium" id="d_quantity"></div>
                            </div>
                            <div class="hidden"><span class="text-gray-500">Mới</span>
                                <div class="font-medium" id="d_newQty"></div>
                            </div>
                            <div class="hidden"><span class="text-gray-500">Hoàn</span>
                                <div class="font-medium" id="d_returnedQty"></div>
                            </div>
                            <div><span class="text-gray-500">Trạng thái</span>
                                <div class="font-medium" id="d_status"></div>
                            </div>
                            <div><span class="text-gray-500">Thương hiệu</span>
                                <div class="font-medium" id="d_brand"></div>
                            </div>
                            <div><span class="text-gray-500">Danh mục</span>
                                <div class="font-medium" id="d_category"></div>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-500">Nhà cung cấp</span>
                                <div class="font-medium" id="d_suppliers"></div>
                            </div>
                            <div><span class="text-gray-500">Đơn vị</span>
                                <div class="font-medium" id="d_unit"></div>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-500">Mô tả</span>
                                <p id="d_description" class="mt-1 text-gray-700 whitespace-pre-line"></p>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-500">Ảnh sản phẩm</span>
                                <div id="d_images" class="grid grid-cols-2 gap-2 mt-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="sticky bottom-0 bg-white border-t px-6 py-4 flex justify-end gap-2">
                        <button onclick="closeDetailModal()" class="px-4 py-2 rounded border hover:bg-gray-50">Đóng
                        </button>
                        <button sec:authorize="hasAnyRole('MANAGER')"
                                onclick="openEditFromDetail()"
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Chỉnh sửa
                        </button>
                    </div>

                    <!-- Ẩn nút lưu id để JS dùng -->
                    <button id="d_editBtn" class="hidden" data-id=""></button>
                </div>
            </div>
        </div>

        <!-- Modal Chỉnh sửa sản phẩm -->
        <div id="editProductModal"
             th:class="${editError} ? 'fixed inset-0 z-50' : 'fixed inset-0 z-50 hidden'">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/40"></div>

            <!-- Panel -->
            <div class="relative mx-auto my-10 w-full max-w-4xl">
                <div class="bg-white rounded-xl shadow-xl overflow-hidden">
                    <!-- Header -->
                    <div class="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
                        <h2 class="text-lg font-semibold">Chỉnh sửa sản phẩm</h2>
                        <button onclick="closeEditModal()" class="p-2 rounded hover:bg-gray-100" aria-label="Đóng">
                            <i class="ri-close-line text-2xl"></i>
                        </button>
                    </div>

                    <!-- Body -->
                    <div class="px-6 py-5 max-h-[70vh] overflow-auto">
                        <form id="editProductForm"
                              th:action="@{/products/update/__${productDTO.id}__}"
                              th:object="${productDTO}"
                              method="post"
                              enctype="multipart/form-data">

                            <input type="hidden" id="editId" name="id" th:field="*{id}"/>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-700">Mã SP</label>
                                    <input type="text" th:field="*{code}" id="editCode"
                                           class="w-full border rounded px-3 py-2"/>
                                    <p th:if="${#fields.hasErrors('code')}" th:errors="*{code}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-700">Tên</label>
                                    <input type="text" th:field="*{name}" id="editName"
                                           class="w-full border rounded px-3 py-2"/>
                                    <p th:if="${#fields.hasErrors('name')}" th:errors="*{name}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>

                                <div>
                                    <label class="text-sm text-gray-700">Giá gốc</label>
                                    <input type="number" th:field="*{originPrice}" id="editOriginPrice"
                                           class="w-full border rounded px-3 py-2"/>
                                    <p th:if="${#fields.hasErrors('originPrice')}" th:errors="*{originPrice}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-700">Giá niêm yết</label>
                                    <input type="number" th:field="*{listingPrice}" id="editListingPrice"
                                           class="w-full border rounded px-3 py-2"/>
                                    <p th:if="${#fields.hasErrors('listingPrice')}" th:errors="*{listingPrice}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>

                                <div>
                                    <label class="text-sm text-gray-700">Trạng thái</label>
                                    <select th:field="*{status}" id="editStatus"
                                            class="w-full border rounded px-3 py-2">
                                        <option value="ACTIVE">Đang hoạt động</option>
                                        <option value="INACTIVE">Ngưng hoạt động</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-700">Số lượng</label>
                                    <input type="number" th:field="*{quantity}" id="editQuantity"
                                           class="w-full border rounded px-3 py-2"/>
                                    <p th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>

                                <div>
                                    <label class="text-sm text-gray-700">Đơn vị</label>
                                    <select th:field="*{unitId}" id="editUnitId" class="w-full border rounded px-3 py-2"
                                            th:disabled="${#lists.isEmpty(units)}">
                                        <option th:each="u : ${units}" th:value="${u.id}" th:text="${u.name}"></option>
                                    </select>
                                    <p th:if="${#lists.isEmpty(units)}" class="text-xs text-red-500 mt-1">Không có đơn
                                        vị nào đang hoạt động</p>
                                </div>

                                <div>
                                    <label class="text-sm text-gray-700">Thương hiệu</label>
                                    <select th:field="*{brandId}" id="editBrandId"
                                            class="w-full border rounded px-3 py-2"
                                            th:disabled="${#lists.isEmpty(brands)}">
                                        <option th:each="b : ${brands}" th:value="${b.id}" th:text="${b.name}"></option>
                                    </select>
                                    <p th:if="${#lists.isEmpty(brands)}" class="text-xs text-red-500 mt-1">Không có
                                        thương hiệu nào đang hoạt động</p>
                                </div>

                                <div>
                                    <label class="text-sm text-gray-700">Danh mục</label>
                                    <select th:field="*{categoryId}" id="editCategoryId"
                                            class="w-full border rounded px-3 py-2"
                                            th:disabled="${#lists.isEmpty(categories)}">
                                        <option th:each="c : ${categories}" th:value="${c.id}"
                                                th:text="${c.name}"></option>
                                    </select>
                                    <p th:if="${#lists.isEmpty(categories)}" class="text-xs text-red-500 mt-1">Không có
                                        danh mục nào đang hoạt động</p>
                                </div>

                                <div class="col-span-2">
                                    <label class="text-sm text-gray-700">Nhà cung cấp</label>
                                    <select id="editSupplierIds"
                                            multiple
                                            th:field="*{supplierIds}"
                                            class="w-full"
                                            th:disabled="${#lists.isEmpty(suppliers)}">
                                        <option th:if="${#lists.isEmpty(suppliers)}" value=""></option>
                                        <option th:each="s : ${suppliers}"
                                                th:value="${s.id}"
                                                th:text="${s.name}"></option>
                                    </select>
                                    <p th:if="${#fields.hasErrors('supplierIds')}" th:errors="*{supplierIds}"
                                       class="text-xs text-red-500 mt-1"></p>
                                    <p th:if="${#lists.isEmpty(suppliers)}" class="text-xs text-red-500 mt-1">Không có
                                        nhà cung cấp nào đang hoạt động</p>
                                </div>

                                <div class="col-span-2">
                                    <label class="text-sm text-gray-700">Ảnh hiện tại</label>
                                    <p class="text-xs text-gray-500 mt-1">Chọn ảnh để xóa.</p>
                                    <div id="editExistingImages" class="grid grid-cols-3 gap-4 mt-2"></div>
                                </div>

                                <div class="col-span-2">
                                    <label class="text-sm text-gray-700">Ảnh mới (nếu cần)</label>
                                    <input type="file" name="images" accept="image/*"
                                           class="w-full border rounded px-3 py-2"/>
                                    <p class="text-xs text-gray-500 mt-1">Nếu không chọn ảnh mới, ảnh hiện tại sẽ được
                                        giữ nguyên.</p>
                                </div>

                                <div class="col-span-2">
                                    <label class="text-sm text-gray-700">Mô tả</label>
                                    <textarea th:field="*{description}" id="editDescription"
                                              class="w-full border rounded px-3 py-2" rows="3"></textarea>
                                    <p th:if="${#fields.hasErrors('description')}" th:errors="*{description}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Footer -->
                    <div class="sticky bottom-0 bg-white border-t px-6 py-4 flex justify-end gap-2">
                        <button type="button" onclick="closeEditModal()"
                                class="px-4 py-2 rounded border hover:bg-gray-50">Hủy
                        </button>
                        <button type="submit" form="editProductForm"
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Lưu
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal Thêm sản phẩm -->
        <div id="productModal"
             class="fixed inset-0 z-50"
             th:classappend="${hasFormError} ? '' : ' hidden'">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/40"></div>

            <!-- Panel -->
            <div class="relative mx-auto my-10 w-full max-w-4xl">
                <div class="bg-white rounded-xl shadow-xl overflow-hidden">
                    <!-- Header -->
                    <div class="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
                        <h2 class="text-lg font-semibold">Thêm sản phẩm mới</h2>
                        <button onclick="closeAddModal()" class="p-2 rounded hover:bg-gray-100" aria-label="Đóng">
                            <i class="ri-close-line text-2xl"></i>
                        </button>
                    </div>

                    <!-- Body -->
                    <div class="px-6 py-5 max-h-[70vh] overflow-auto">
                        <form id="addProductForm" th:action="@{/products}" th:object="${productDTO}" method="post"
                              enctype="multipart/form-data">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-700">Mã SP
                                        <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" th:field="*{code}" class="w-full border rounded px-3 py-2"/>
                                    <p th:if="${#fields.hasErrors('code')}" th:errors="*{code}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-700">Tên
                                        <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" th:field="*{name}" class="w-full border rounded px-3 py-2"/>
                                    <p th:if="${#fields.hasErrors('name')}" th:errors="*{name}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>

                                <div class="col-span-2">
                                    <label class="text-sm text-gray-700">Ảnh sản phẩm</label>
                                    <input type="file" name="images" accept="image/*"
                                           class="w-full border rounded px-3 py-2"/>
                                </div>

                                <div>
                                    <label class="text-sm text-gray-700">Giá gốc
                                        <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" th:field="*{originPrice}"
                                           class="w-full border rounded px-3 py-2"/>
                                    <p th:if="${#fields.hasErrors('originPrice')}" th:errors="*{originPrice}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-700">Giá niêm yết
                                        <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" th:field="*{listingPrice}"
                                           class="w-full border rounded px-3 py-2"/>
                                    <p th:if="${#fields.hasErrors('listingPrice')}" th:errors="*{listingPrice}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>

                                <input type="hidden" name="status" value="ACTIVE"/>

                                <div>
                                    <label class="text-sm text-gray-700">Số lượng
                                        <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" th:field="*{quantity}"
                                           class="w-full border rounded px-3 py-2"/>
                                    <p th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>

                                <div>
                                    <label class="text-sm text-gray-700">Đơn vị</label>
                                    <select th:field="*{unitId}" class="w-full border rounded px-3 py-2"
                                            th:disabled="${#lists.isEmpty(units)}">
                                        <option th:if="${#lists.isEmpty(units)}" value=""></option>
                                        <option th:each="u : ${units}" th:value="${u.id}" th:text="${u.name}"></option>
                                    </select>
                                    <p th:if="${#lists.isEmpty(units)}" class="text-xs text-red-500 mt-1">Không có đơn
                                        vị nào đang hoạt động</p>
                                </div>

                                <div>
                                    <label class="text-sm text-gray-700">Thương hiệu</label>
                                    <select th:field="*{brandId}" class="w-full border rounded px-3 py-2"
                                            th:disabled="${#lists.isEmpty(brands)}">
                                        <option th:if="${#lists.isEmpty(brands)}" value=""></option>
                                        <option th:each="b : ${brands}" th:value="${b.id}" th:text="${b.name}"></option>
                                    </select>
                                    <p th:if="${#lists.isEmpty(brands)}" class="text-xs text-red-500 mt-1">Không có
                                        thương hiệu nào đang hoạt động</p>
                                </div>

                                <div>
                                    <label class="text-sm text-gray-700">Danh mục</label>
                                    <select th:field="*{categoryId}" class="w-full border rounded px-3 py-2"
                                            th:disabled="${#lists.isEmpty(categories)}">
                                        <option th:if="${#lists.isEmpty(categories)}" value=""></option>
                                        <option th:each="c : ${categories}" th:value="${c.id}"
                                                th:text="${c.name}"></option>
                                    </select>
                                    <p th:if="${#lists.isEmpty(categories)}" class="text-xs text-red-500 mt-1">Không có
                                        danh mục nào đang hoạt động</p>
                                </div>

                                <div class="col-span-2">
                                    <label class="text-sm text-gray-700">Nhà cung cấp
                                        <span class="text-red-500">*</span>
                                    </label>
                                    <select id="addSupplierIds" multiple th:field="*{supplierIds}" class="w-full">
                                        <option th:each="s : ${suppliers}" th:value="${s.id}"
                                                th:text="${s.name}"></option>
                                    </select>
                                    <p th:if="${#fields.hasErrors('supplierIds')}" th:errors="*{supplierIds}"
                                       class="text-xs text-red-500 mt-1"></p>
                                    <p th:if="${#lists.isEmpty(suppliers)}" class="text-xs text-red-500 mt-1">Không có
                                        nhà cung cấp nào đang hoạt động</p>
                                </div>

                                <div class="col-span-2">
                                    <label class="text-sm text-gray-700">Mô tả</label>
                                    <textarea th:field="*{description}" class="w-full border rounded px-3 py-2"
                                              rows="3"></textarea>
                                    <p th:if="${#fields.hasErrors('description')}" th:errors="*{description}"
                                       class="text-xs text-red-500 mt-1"></p>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Footer -->
                    <div class="sticky bottom-0 bg-white border-t px-6 py-4 flex justify-end gap-2">
                        <button type="button" onclick="closeAddModal()"
                                class="px-4 py-2 rounded border hover:bg-gray-50">Hủy
                        </button>
                        <button type="submit" form="addProductForm"
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Lưu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<!-- Footer -->
<div class="hidden" th:insert="~{fragments/footer :: footer}"></div>


<script th:inline="javascript">
    let addChoices, editChoices;

    function initAddChoices() {
        const el = document.getElementById('addSupplierIds');
        if (el && !addChoices) {
            addChoices = new Choices(el, {removeItemButton: true, searchPlaceholderValue: 'Tìm NCC…'});
        }
    }

    function initEditChoices() {
        const el = document.getElementById('editSupplierIds');
        if (!el) return;
        if (editChoices) {
            editChoices.destroy();
            editChoices = null;
        }
        editChoices = new Choices(el, {
            removeItemButton: true,
            searchPlaceholderValue: 'Tìm NCC…',
            shouldSort: false
        });
    }

    function openAddModal() {
        document.getElementById('productModal').classList.remove('hidden');
        initAddChoices();
    }

    //đóng modal thêm sản phẩm
    function closeAddModal() {
        const modal = document.getElementById('productModal');
        modal.classList.add('hidden');

        const form = document.getElementById('addProductForm');
        if (form) {
            form.reset();

            // Reset các input/textarea/select có name (dù dùng th:field)
            form.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.type !== 'hidden' && el.name) el.value = '';
            });

            // Xoá các message lỗi hiển thị
            form.querySelectorAll('.text-red-500').forEach(el => el.innerText = '');
        }

        // ✅ Redirect nhẹ để xoá trạng thái lỗi backend
        window.location.href = '/products';
    }

    function openDetailModal(anchor) {
        const tr = anchor.closest('tr');
        document.getElementById('d_code').innerText = tr.dataset.code;
        document.getElementById('d_name').innerText = tr.dataset.name;
        document.getElementById('d_originPrice').innerText = tr.dataset.originprice;
        document.getElementById('d_listingPrice').innerText = tr.dataset.listingprice;
        document.getElementById('d_quantity').innerText = tr.dataset.quantity;
        document.getElementById('d_newQty').innerText = tr.dataset.newqty || '0';
        document.getElementById('d_returnedQty').innerText = tr.dataset.returnedqty || '0';
        document.getElementById('d_suppliers').innerText =
            (tr.dataset.supplierNames || '').split(',').filter(Boolean).join(', ') || '—';

        //đổi Enum trạng thái thành text teiesng việt
        const statusCode = tr.dataset.status;
        document.getElementById('d_status').innerText = statusCode === 'ACTIVE' ? 'Đang hoạt động' : 'Ngưng hoạt động';

        document.getElementById('d_brand').innerText = tr.dataset.brand;
        document.getElementById('d_category').innerText = tr.dataset.category;
        document.getElementById('d_unit').innerText = tr.dataset.unit;
        document.getElementById('d_description').innerText = tr.dataset.description;

        // ID dùng cho xử lý mở edit từ modal này
        const btn = document.getElementById('d_editBtn');
        btn.dataset.id = tr.dataset.id;

        // Render ảnh (chỉ 1)
        const container = document.getElementById('d_images');
        container.innerHTML = '';

        // thay vì lấy ảnh từ data-images thì clone trực tiếp từ cột ảnh trong bảng
        const imgInTable = tr.querySelector('td:nth-child(3) img'); // cột ảnh là cột thứ 3
        if (imgInTable) {
            const clonedImg = imgInTable.cloneNode(true);
            clonedImg.className = 'w-full h-32 object-cover rounded border'; // nếu muốn resize lại
            container.appendChild(clonedImg);
        } else {
            container.innerHTML = '<p class="text-sm italic text-gray-500">Không có ảnh sản phẩm</p>';
        }

        document.getElementById('detailProductModal').classList.remove('hidden');
    }

    function closeDetailModal() {
        document.getElementById('detailProductModal').classList.add('hidden');
    }

    // Mở modal chỉnh sửa từ dòng sản phẩm
    function openEditModal(anchor) {
        const tr = anchor.closest('tr');
        const isFromServerError = /*[[${editError != null}]]*/ false;

        if (!isFromServerError) {
            document.getElementById('editId').value = tr.dataset.id;
            document.getElementById('editCode').value = tr.dataset.code;
            document.getElementById('editName').value = tr.dataset.name;
            document.getElementById('editOriginPrice').value = tr.dataset.originprice;
            document.getElementById('editListingPrice').value = tr.dataset.listingprice;
            document.getElementById('editQuantity').value = tr.dataset.quantity;
            document.getElementById('editStatus').value = tr.dataset.status;
            document.getElementById('editUnitId').value = tr.dataset.unitId;
            document.getElementById('editBrandId').value = tr.dataset.brandId;
            document.getElementById('editCategoryId').value = tr.dataset.categoryId;
            document.getElementById('editDescription').value = tr.dataset.description;

            // Set action cho form chỉnh sửa
            document.getElementById('editProductForm').action = `/products/update/${tr.dataset.id}`;

            const container = document.getElementById('editExistingImages');
            container.innerHTML = '';

            const imgInTable = tr.querySelector('td:nth-child(3) img');
            if (imgInTable) {
                const wrapper = document.createElement("div");
                wrapper.className = "relative w-28";

                const img = imgInTable.cloneNode(true);
                img.className = "w-full h-20 object-cover rounded border";

                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.name = "deletedImages";
                checkbox.value = img.src;
                checkbox.className = "absolute top-1 left-1 w-4 h-4";

                wrapper.appendChild(img);
                wrapper.appendChild(checkbox);
                container.appendChild(wrapper);
            } else {
                container.innerHTML = '<p class="text-sm italic text-gray-500">Không có ảnh sản phẩm</p>';
            }
        }

        //Chọn sẵn NCC trên <select>
        const sel = document.getElementById('editSupplierIds');
        const idsStr = tr.dataset.supplierIds || '';
        const selectedIds = idsStr ? idsStr.split(',').map(s => s.trim()) : [];
        // 1) clear selected cũ ở thẻ select “thật”
        Array.from(sel.options).forEach(op => {
            op.selected = false;
        });
        // 2) đặt lại selected theo dữ liệu của hàng
        selectedIds.forEach(id => {
            const opt = Array.from(sel.options).find(o => String(o.value) === String(id));
            if (opt) opt.selected = true;
        });

        // Hiện modal trước khi init Choices (để layout ổn định)
        document.getElementById('editProductModal').classList.remove('hidden');

        // 3) Khởi tạo Choices sau khi options đã được selected
        initEditChoices();

        // 4) Đồng bộ lần nữa bằng API Choices (ổn định cho mọi phiên bản Choices)
        if (editChoices && selectedIds.length && !isFromServerError) {
            // KHÔNG removeActiveItems ở đây để tránh mất chọn
            selectedIds.forEach(v => {
                editChoices.setChoiceByValue(String(v));
            });
        }
    }

    // Đóng modal chỉnh sửa và reset form
    function closeEditModal() {
        const modal = document.getElementById('editProductModal');
        modal.classList.add('hidden');

        // Hủy Choices để tránh giữ trạng thái cũ
        if (editChoices) {
            editChoices.destroy();
            editChoices = null;
        }

        // Reset form
        const form = document.getElementById('editProductForm');
        if (form) {
            form.reset();
            form.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.type !== 'hidden') el.value = '';
            });
            form.querySelectorAll('.text-red-500').forEach(el => el.innerText = '');
            const container = document.getElementById('editExistingImages');
            if (container) container.innerHTML = '';
        }

        //Sau khi reset, redirect nhẹ để xóa các biến lỗi khỏi model
        window.location.href = '/products';
    }


    // Mở lại modal chỉnh sửa nếu có lỗi validate từ backend
    const editError = /*[[${editError}]]*/ false;
    const editId = /*[[${editId}]]*/ null;

    if (editError && editId !== null && editId !== '') {
        const row = document.querySelector(`tr[data-id='${editId}']`);
        if (row) {
            openEditModal(row.querySelector("a[onclick*='openEditModal']"));
        }
    }


    function toggleStatus(checkbox) {
        const productId = checkbox.dataset.id;
        const newStatus = checkbox.checked ? 'ACTIVE' : 'INACTIVE';

        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        fetch(`/products/${productId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({status: newStatus})
        })
            .then(res => {
                if (!res.ok) throw new Error("Lỗi khi cập nhật trạng thái");
                return res.text();
            })
            .then(msg => {
                // Cập nhật badge
                const td = checkbox.closest("td");
                const badge = td.querySelector("[data-status-badge]");
                if (badge) {
                    if (checkbox.checked) {
                        badge.textContent = "Đang hoạt động";
                        badge.classList.remove("bg-red-100", "text-red-700");
                        badge.classList.add("bg-green-100", "text-green-700");
                    } else {
                        badge.textContent = "Ngưng hoạt động";
                        badge.classList.remove("bg-green-100", "text-green-700");
                        badge.classList.add("bg-red-100", "text-red-700");
                    }
                }

                // Cập nhật dataset của hàng
                const tr = checkbox.closest("tr");
                tr.dataset.status = checkbox.checked ? "ACTIVE" : "INACTIVE";
            });
    }

    function openEditFromDetail() {
        const id = document.getElementById('d_editBtn').dataset.id;
        const row = document.querySelector(`tr[data-id='${id}']`);
        closeDetailModal();
        openEditModal(row.querySelector("a[onclick*='openEditModal']"));
    }

    //load lại trang và modal thêm sản phẩm đang mở sẵn, init Choices để hiển thị multiselect
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('productModal');
        if (modal && !modal.classList.contains('hidden')) {
            initAddChoices();
        }
    });

    // Khởi tạo Choices cho ô filter NCC (để chặn dropdown nở dài)
    function initFilterSupplierChoices() {
        const el = document.getElementById('filterSupplierId');
        if (!el || el.dataset.choicesInit === '1') return;
        new Choices(el, {
            shouldSort: false,
            itemSelectText: '',
            searchPlaceholderValue: 'Tìm NCC…'
        });
        el.dataset.choicesInit = '1';
    }

    // Gọi khi DOM ready (giữ nguyên các đoạn khác của bạn)
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('productModal');
        if (modal && !modal.classList.contains('hidden')) {
            initAddChoices();
        }
        initFilterSupplierChoices();   // <-- THÊM DÒNG NÀY
    });

</script>
</body>

</html>
