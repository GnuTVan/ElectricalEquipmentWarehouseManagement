<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{fragments/common-head :: commonHead('Tạo đơn hàng bán')}"></head>

<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <main id="mainContent" class="flex-1 ml-64 transition-all duration-300 relative">
        <div th:replace="~{fragments/header :: header}"></div>

        <div class="justify-between items-center mb-4 px-6 py-6">
            <h1 class="text-2xl font-bold mb-4">Tạo đơn hàng bán</h1>

            <form th:action="@{/sale-orders/create}" method="post" th:object="${saleOrderForm}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Khách hàng -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Khách hàng</label>
                        <select th:field="*{customerId}" class="w-full border rounded px-3 py-2" required>
                            <option value="">-- Chọn khách hàng --</option>
                            <option th:each="c : ${customers}" th:value="${c.id}" th:text="${c.fullName}"></option>
                        </select>
                    </div>

                    <!-- Combo (multi-tag) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chọn combo</label>
                        <select id="comboSelect" name="comboIds" multiple class="w-full border rounded px-3 py-2">
                            <option th:each="cb : ${combos}" th:value="${cb.id}" th:text="${cb.code + ' - ' + cb.name}"></option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú</label>
                    <textarea th:field="*{description}" rows="3" class="w-full border rounded px-3 py-2"></textarea>
                </div>

                <!-- Danh sách sản phẩm -->
                <div class="mb-6">
                    <h2 class="text-lg font-semibold mb-2">Danh sách sản phẩm</h2>

                    <table class="min-w-full bg-white rounded shadow text-sm">
                        <thead class="bg-gray-100">
                        <tr>
                            <th class="px-3 py-2 text-left">Sản phẩm</th>
                            <th class="px-3 py-2 text-center">Tồn kho</th>
                            <th class="px-3 py-2 text-center">Số lượng</th>
                            <th class="px-3 py-2 text-center">Đơn giá</th>
                            <th class="px-3 py-2 text-center">Thành tiền</th>
                            <th class="px-3 py-2 text-center">Xoá</th>
                        </tr>
                        </thead>
                        <tbody id="itemTableBody"><!-- combo + manual rows sẽ được render vào đây --></tbody>
                        <tfoot>
                        <tr>
                            <td colspan="4" class="px-3 py-2 text-right font-semibold">Tổng tiền:</td>
                            <td class="px-3 py-2 text-right font-bold" id="grandTotal">0</td>
                            <td></td>
                        </tr>
                        </tfoot>
                    </table>

                    <button type="button" id="btnAddRow"
                            class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                        <i class="ri-add-line mr-1"></i> Thêm sản phẩm
                    </button>
                    <div id="productLimitMsg" class="mt-2 text-sm text-red-500 hidden">
                        Tất cả sản phẩm lẻ đã được chọn. Không thể thêm dòng mới.
                    </div>
                </div>

                <div class="text-right">
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">
                        <i class="ri-save-line mr-1"></i> Lưu đơn hàng
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<div class="hidden" th:replace="~{fragments/footer :: footer}"></div>

<!-- CSRF + dữ liệu sản phẩm -->
<script th:inline="javascript">
    const csrfHeader = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
    const csrfToken  = /*[[${_csrf.token}]]*/ '';
    const products   = /*[[${products}]]*/ [];
</script>

<!-- Choices.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<script>
    /* ============== Utils ============== */
    const tableBody  = document.getElementById('itemTableBody');
    const productMap = new Map(products.map(p => [String(p.id), p]));

    function fmt(n){ return (Number(n)||0).toLocaleString('vi-VN'); }
    function esc(s){ return String(s||'').replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
    function debounce(fn, t=150){ let id; return (...a)=>{ clearTimeout(id); id=setTimeout(()=>fn(...a), t); } }

    /* ============== Tính tiền & reindex ============== */
    function recalcRowTotal(tr){
        const qty   = Number(tr.querySelector('.quantity')?.value || 0);
        const price = Number(tr.querySelector('.price')?.value || 0);
        tr.querySelector('.lineTotal').textContent = fmt(qty * price);
    }
    function recalcGrand(){
        let total = 0;
        tableBody.querySelectorAll('tr[data-product-id]').forEach(tr=>{
            const qty   = Number(tr.querySelector('.quantity')?.value || 0);
            const price = Number(tr.querySelector('.price')?.value || 0);
            total += qty * price;
        });
        document.getElementById('grandTotal').textContent = fmt(total);
    }
    function reindexAllRows(){
        const rows = tableBody.querySelectorAll('tr[data-product-id]');
        rows.forEach((tr, idx)=>{
            tr.querySelectorAll('input, select').forEach(el=>{
                if(!el.name) return;
                el.name = el.name.replace(/\[\d+]/, `[${idx}]`);
            });
        });
    }

    /* ============== Chống trùng (chỉ trong dòng lẻ) ============== */
    function getUsedManualIds(){
        return Array.from(tableBody.querySelectorAll('tr[data-source="manual"]'))
            .map(tr=>tr.dataset.productId).filter(Boolean);
    }
    function buildManualOptions(currentPid){
        const used = new Set(getUsedManualIds().filter(id => id !== String(currentPid)));
        return products
            .filter(p => !used.has(String(p.id)))
            .map(p => `<option value="${p.id}" data-price="${p.listingPrice}" data-stock="${p.quantity}">${esc(p.name)}</option>`)
            .join('');
    }
    function refreshAllManualSelects(){
        tableBody.querySelectorAll('tr[data-source="manual"]').forEach(tr=>{
            const sel = tr.querySelector('.product-select');
            if(!sel) return;
            const cur = sel.value;
            sel.innerHTML = buildManualOptions(cur);
            sel.value = cur;
        });
    }

    /* ============== Dòng lẻ (manual) ============== */
    function createManualRow({pid, price, stock, qty}){
        const index = tableBody.querySelectorAll('tr[data-product-id]').length;
        const tr = document.createElement('tr');
        tr.dataset.productId = String(pid);
        tr.dataset.source = 'manual';

        tr.innerHTML = `
    <td class="px-3 py-2">
      <select name="details[${index}].productId" class="w-full border rounded px-2 py-1 product-select"></select>
      <input type="hidden" name="details[${index}].source" value="MANUAL">
      <input type="hidden" name="details[${index}].comboId" value="">
      <input type="hidden" name="details[${index}].comboName" value="">
    </td>
    <td class="px-3 py-2 text-center align-middle">
      <span class="stock-display font-semibold text-gray-800 border border-gray-400 px-2 py-1 rounded bg-white inline-block min-w-[40px]">${stock ?? '-'}</span>
    </td>
    <td class="px-3 py-2 text-center">
      <input type="number" name="details[${index}].orderedQuantity" class="border px-2 py-1 w-full quantity" value="${qty}" min="1">
    </td>
    <td class="px-3 py-2 text-center">
      <input type="number" name="details[${index}].price" class="border px-2 py-1 w-full price" value="${price}" readonly>
    </td>
    <td class="px-3 py-2 text-right"><span class="lineTotal">0</span></td>
    <td class="px-3 py-2 text-center">
      <button type="button" class="text-red-600 text-lg btn-remove" title="Xoá dòng"><i class="ri-close-line"></i></button>
    </td>
  `;
        tableBody.appendChild(tr);

        const sel = tr.querySelector('.product-select');
        sel.innerHTML = buildManualOptions(pid);
        sel.value = String(pid);

        attachManualListeners(tr);
        recalcRowTotal(tr);
        return tr;
    }
    function attachManualListeners(tr){
        const sel = tr.querySelector('.product-select');
        const qtyInput = tr.querySelector('.quantity');
        const priceInput = tr.querySelector('.price');

        sel.addEventListener('change', ()=>{
            const pid = sel.value;
            tr.dataset.productId = pid;
            const p = productMap.get(String(pid)) || {};
            priceInput.value = Number(p.listingPrice || 0);
            tr.querySelector('.stock-display').textContent = p.quantity ?? '-';
            refreshAllManualSelects();
            recalcRowTotal(tr);
            recalcGrand();
        });
        qtyInput.addEventListener('input', ()=>{
            const v = Number(qtyInput.value || 0);
            qtyInput.value = isNaN(v) || v < 1 ? 1 : v;
            recalcRowTotal(tr);
            recalcGrand();
        });
        tr.querySelector('.btn-remove').addEventListener('click', ()=>{
            tr.remove();
            refreshAllManualSelects();
            reindexAllRows();
            recalcGrand();
        });
    }
    document.getElementById('btnAddRow').addEventListener('click', ()=>{
        const used = new Set(getUsedManualIds());
        const candidate = products.find(p => !used.has(String(p.id))); // cho phép trùng với combo
        const msg = document.getElementById('productLimitMsg');

        if(!candidate){ msg.classList.remove('hidden'); return; }
        msg.classList.add('hidden');

        createManualRow({
            pid: candidate.id,
            price: candidate.listingPrice || 0,
            stock: candidate.quantity ?? '-',
            qty: 1
        });
        reindexAllRows();
        refreshAllManualSelects();
        recalcGrand();
    });

    /* ============== Dòng combo (readonly) ============== */
    function createComboRow(it, {mount=true} = {}){
        const pid   = String(it.productId);
        const price = Number(it.price ?? (productMap.get(pid)?.listingPrice ?? 0));
        const stock = it.availableQuantity ?? (productMap.get(pid)?.quantity ?? '-');
        const qty   = Number(it.quantity || 0);

        const index = tableBody.querySelectorAll('tr[data-product-id]').length;
        const tr = document.createElement('tr');
        tr.dataset.productId = pid;
        tr.dataset.comboId   = String(it.comboId || '');
        tr.dataset.source    = 'combo';
        tr.dataset.key       = `${tr.dataset.comboId}:${pid}`;
        tr.classList.add('bg-amber-50'); // highlight

        tr.innerHTML = `
    <td class="px-3 py-2">
      <div class="flex items-center gap-2">
        <span class="inline-flex text-[11px] px-2 py-0.5 rounded-full border border-amber-400 bg-amber-100 text-amber-800">
          Combo: ${esc(it.comboName || it.comboCode || '#')}
        </span>
        <input type="hidden" name="details[${index}].productId" value="${pid}">
        <input type="hidden" name="details[${index}].source" value="COMBO">
        <input type="hidden" name="details[${index}].comboId" value="${esc(it.comboId)}">
        <input type="hidden" name="details[${index}].comboName" value="${esc(it.comboName || it.comboCode || '')}">
        <span class="font-medium">${esc(it.productName || productMap.get(pid)?.name || '(Sản phẩm)')}</span>
      </div>
    </td>
    <td class="px-3 py-2 text-center align-middle"><span class="stock-display">${stock}</span></td>
    <td class="px-3 py-2 text-center">
      <input type="number" name="details[${index}].orderedQuantity" class="border px-2 py-1 w-full quantity" value="${qty}" min="1" readonly>
    </td>
    <td class="px-3 py-2 text-center">
      <input type="number" name="details[${index}].price" class="border px-2 py-1 w-full price" value="${price}" readonly>
    </td>
    <td class="px-3 py-2 text-right"><span class="lineTotal">0</span></td>
    <td class="px-3 py-2 text-center">
      <button type="button" class="text-gray-300 cursor-not-allowed" title="Thuộc combo, không xoá được">
        <i class="ri-lock-2-line"></i>
      </button>
    </td>
  `;
        recalcRowTotal(tr);
        if (mount) tableBody.appendChild(tr);
        return tr;
    }
    function patchComboRow(tr, it){
        const pid   = String(it.productId);
        const price = Number(it.price ?? (productMap.get(pid)?.listingPrice ?? 0));
        const stock = it.availableQuantity ?? (productMap.get(pid)?.quantity ?? '-');
        const qty   = Number(it.quantity || 0);

        tr.querySelector('.stock-display').textContent = stock;
        tr.querySelector('.quantity').value = qty;
        tr.querySelector('.price').value = price;
        recalcRowTotal(tr);
    }

    /* ============== Combo diff (không giật) ============== */
    const rebuildComboRows = debounce(async function(selectedComboIds){
        tableBody.style.visibility = 'hidden'; // giảm cảm giác giật

        try {
            const curComboRows = Array.from(tableBody.querySelectorAll('tr[data-source="combo"]'));
            const rowByKey = new Map(curComboRows.map(tr => [tr.dataset.key, tr]));

            if(!selectedComboIds || !selectedComboIds.length){
                curComboRows.forEach(tr => tr.remove());
                reindexAllRows(); recalcGrand();
                return;
            }

            const res = await fetch('/combos/expand', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', [csrfHeader]: csrfToken},
                body: JSON.stringify(selectedComboIds)
            });
            const items = await res.json(); // [{comboId, comboName, productId, productName, quantity, price, availableQuantity?}, ...]

            const nextKeys = new Set();
            const frag = document.createDocumentFragment();

            for (const it of items){
                const key = `${it.comboId}:${it.productId}`;
                nextKeys.add(key);
                const existed = rowByKey.get(key);
                if (existed){
                    patchComboRow(existed, it);
                    existed.dataset._kept = '1';
                } else {
                    const tr = createComboRow(it, {mount:false});
                    frag.appendChild(tr);
                }
            }

            // xoá dòng combo không còn trong tập mới
            for(const tr of curComboRows){
                if(!nextKeys.has(tr.dataset.key)) tr.remove();
            }

            // chèn các combo mới (đặt combo đứng TRƯỚC các dòng lẻ, nếu muốn)
            const firstManual = tableBody.querySelector('tr[data-source="manual"]');
            if(frag.childNodes.length){
                if(firstManual) tableBody.insertBefore(frag, firstManual);
                else tableBody.appendChild(frag);
            }

            reindexAllRows();
            recalcGrand();
        } catch(e){
            console.error(e);
            if(window.toastError) toastError('Không thể tải sản phẩm từ combo');
        } finally {
            requestAnimationFrame(()=>{ tableBody.style.visibility = ''; });
        }
    }, 160);

    document.addEventListener('DOMContentLoaded', ()=>{
        new Choices('#comboSelect', { removeItemButton:true, shouldSort:false, placeholder:true, placeholderValue:'Chọn combo' });

        const comboSelect = document.getElementById('comboSelect');
        comboSelect.addEventListener('change', ()=>{
            const selectedIds = Array.from(comboSelect.selectedOptions).map(o => Number(o.value));
            rebuildComboRows(selectedIds);
        });

        // Reindex trước khi submit để name[] chuẩn
        const form = document.querySelector('form');
        form.addEventListener('submit', ()=>{ reindexAllRows(); });
    });
</script>
</body>
</html>
