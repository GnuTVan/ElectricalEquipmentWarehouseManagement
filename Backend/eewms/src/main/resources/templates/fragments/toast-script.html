<!-- fragments/toast-script.html -->
<div th:fragment="toast-script">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const message = /*[[${message}]]*/ null;
        const messageType = /*[[${messageType}]]*/ null;

        if (message && messageType) {
            toastr.options = {
                closeButton: true,
                progressBar: true,
                positionClass: "toast-top-right"
            };
            toastr[messageType](message);

            // --- Gửi lưu lịch sử thông báo (best-effort) ---
            try {
                const csrfH = document.querySelector('meta[name="_csrf_header"]')?.content;
                const csrfT = document.querySelector('meta[name="_csrf"]')?.content;
                const headers = {'Content-Type': 'application/json'};
                if (csrfH && csrfT) headers[csrfH] = csrfT;

                fetch('/admin/notifications', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ type: String(messageType).toLowerCase(), message: message })
                }).then(() => {
                    // Cập nhật badge ngay sau khi lưu thành công
                    if (window.__notif_inc) {
                        window.__notif_inc();
                    } else {
                        // notification-bell.js chưa sẵn sàng → đặt cờ tăng bù
                        sessionStorage.setItem('notif_inc_pending', '1');
                    }
                }).catch(()=>{});
            } catch(e) { /* noop */ }
        }
        /*]]>*/
    </script>
</div>
