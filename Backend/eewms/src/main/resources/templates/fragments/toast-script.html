<!-- fragments/toast-script.html -->
<div th:fragment="toast-script">
    <script th:src="@{/assets/js/jquery-3.6.0.min.js}" defer></script>
    <link th:href="@{/assets/css/toastr.min.css}" rel="stylesheet" />
    <script th:src="@{/assets/js/toastr.min.js}" ></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const message = /*[[${message}]]*/ null;
        const messageType = /*[[${messageType}]]*/ null;

        async function __refreshNotifBadgeFromServer(){
            try{
                const r = await fetch('/admin/notifications/unread-count', { headers: { 'Accept':'application/json' } });
                if(!r.ok) return;
                const {count} = await r.json();
                const badge = document.getElementById('notifBadge');
                if(!badge) return;
                const n = parseInt(count||0,10)||0;
                badge.textContent = n;
                badge.classList.toggle('hidden', n===0);
            }catch(e){}
        }

        if (message && messageType) {
            toastr.options = {
                closeButton: true,
                progressBar: true,
                positionClass: "toast-top-right"
            };
            toastr[String(messageType).toLowerCase()](message);

            // --- Lưu lịch sử thông báo theo user hiện tại ---
            try {
                const csrfH = document.querySelector('meta[name="_csrf_header"]')?.content;
                const csrfT = document.querySelector('meta[name="_csrf"]')?.content;
                const headers = {'Content-Type': 'application/json', 'Accept':'application/json'};
                if (csrfH && csrfT) headers[csrfH] = csrfT;

                // Đổi endpoint: ghi log cho user hiện tại
                fetch('/admin/notifications/log', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        type: String(messageType).toLowerCase(),
                        message: message
                    })
                }).then(() => {
                    // Làm mới badge từ server để đồng bộ
                    __refreshNotifBadgeFromServer();
                }).catch(()=>{});
            } catch(e) { /* noop */ }
        }
        /*]]>*/
    </script>
</div>
