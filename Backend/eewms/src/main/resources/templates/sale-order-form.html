<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tạo đơn hàng bán</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <main class="flex-1 ml-64 p-6">
        <div th:replace="~{fragments/header :: header}"></div>

        <h1 class="text-2xl font-bold mb-4">Tạo đơn hàng bán</h1>

        <form th:action="@{/sale-orders/create}" method="post" th:object="${saleOrderForm}">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Khách hàng</label>
                    <select th:field="*{customerId}" class="w-full border rounded px-3 py-2" required>
                        <option value="">-- Chọn khách hàng --</option>
                        <option th:each="c : ${customers}" th:value="${c.id}" th:text="${c.fullName}"></option>
                    </select>
                </div>
                <div></div> <!-- Cột trống để ghi chú xuống hàng -->
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú</label>
                <textarea th:field="*{description}" rows="3" class="w-full border rounded px-3 py-2"></textarea>
            </div>

            <!-- Danh sách sản phẩm -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-2">Danh sách sản phẩm</h2>
                <table class="min-w-full bg-white rounded shadow text-sm">
                    <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left">Sản phẩm</th>
                        <th class="px-3 py-2 text-center">Số lượng yêu cầu</th>
                        <th class="px-3 py-2 text-center">Đơn giá</th>
                        <th class="px-3 py-2 text-center">Thành tiền</th>
                        <th class="px-3 py-2 text-center">Xoá</th>
                    </tr>
                    </thead>
                    <tbody id="itemTableBody"></tbody>
                    <tfoot>
                    <tr>
                        <td colspan="3" class="px-3 py-2 text-right font-semibold">Tổng tiền:</td>
                        <td class="px-3 py-2 text-right font-bold" id="grandTotal">0</td>
                        <td></td>
                    </tr>
                    </tfoot>
                </table>

                <button type="button" onclick="addItemRow()"
                        class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                    <i class="ri-add-line mr-1"></i> Thêm sản phẩm
                </button>
            </div>

            <div class="text-right">
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">
                    <i class="ri-save-line mr-1"></i> Lưu đơn hàng
                </button>
            </div>
        </form>
    </main>
</div>

<script th:inline="javascript">
    const products = /*[[${products}]]*/ [];

    function addItemRow() {
        const table = document.getElementById('itemTableBody');
        const index = table.children.length;

        let productOptions = products.map(p =>
            `<option value="${p.id}" data-price="${p.listingPrice}" data-stock="${p.quantity}">
                ${p.name}
            </option>`).join('');

        const row = document.createElement('tr');
        row.innerHTML = `
        <td class="px-3 py-2">
            <select name="details[${index}].productId" class="w-full border rounded px-2 py-1 product-select" onchange="updatePrice(this)">
                ${productOptions}
            </select>
            <div class="text-xs text-gray-500 mt-1">Tồn kho: <span class="stock-display">0</span></div>
        </td>
        <td class="px-3 py-2 text-center">
            <input type="number" name="details[${index}].orderedQuantity" class="border px-2 py-1 w-full quantity" value="1" min="1" oninput="calculateTotal(this)">
        </td>
        <td class="px-3 py-2 text-center">
            <input type="number" name="details[${index}].price" class="border px-2 py-1 w-full price" readonly>
        </td>
        <td class="px-3 py-2 text-right">
            <span class="lineTotal">0</span>
        </td>
        <td class="px-3 py-2 text-center">
            <button type="button" onclick="this.closest('tr').remove(); recalculateTotal()" class="text-red-600 text-lg">
                <i class="ri-close-line"></i>
            </button>
        </td>`;

        table.appendChild(row);
        const select = row.querySelector('.product-select');
        updatePrice(select);
        recalculateTotal();
    }

    function updatePrice(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const price = parseFloat(selectedOption.dataset.price || 0);
        const stock = parseInt(selectedOption.dataset.stock || 0);
        const row = selectElement.closest('tr');
        const priceInput = row.querySelector('.price');
        const stockDisplay = row.querySelector('.stock-display');

        priceInput.value = price.toFixed(0);
        stockDisplay.textContent = stock;
        calculateTotal(priceInput);
    }

    function calculateTotal(inputElement) {
        const row = inputElement.closest('tr');
        const qty = parseFloat(row.querySelector('.quantity').value || 0);
        const price = parseFloat(row.querySelector('.price').value || 0);
        const total = qty * price;
        row.querySelector('.lineTotal').textContent = total.toFixed(0);
        recalculateTotal();
    }

    function recalculateTotal() {
        const rows = document.querySelectorAll('#itemTableBody tr');
        let total = 0;
        rows.forEach(row => {
            const lineTotal = parseFloat(row.querySelector('.lineTotal').textContent || 0);
            total += lineTotal;
        });
        document.getElementById('grandTotal').textContent = total.toFixed(0);
    }
</script>
</body>
</html>
