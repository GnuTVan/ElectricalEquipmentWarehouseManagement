<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/common-head :: commonHead('Chuyển kho')}"></head>

<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- Main content -->
    <main id="mainContent" class="flex-1 ml-64 transition-all duration-300 relative">
        <!-- Header -->
        <div th:replace="~{fragments/header :: header}"></div>

        <!-- Flash/Toast zone (trùng pattern với bán hàng) -->
        <div class="flex justify-between items-center mb-4 px-4 py-4">
            <div th:if="${success}" id="alertSuccess" class="mb-4 bg-green-100 text-green-800 px-4 py-2 rounded">
                <p th:text="${success}"></p>
            </div>
            <div th:if="${error}" class="bg-red-100 text-red-700 px-4 py-2 rounded mb-4">
                <i class="ri-error-warning-line mr-1"></i> <span th:text="${error}"></span>
            </div>
            <div th:if="${warning}" id="alertWarning"
                 class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded mb-4 border-l-4 border-yellow-500 shadow">
                <i class="ri-alert-line mr-1"></i> <span th:text="${warning}"></span>
            </div>
            <div th:if="${info}" class="bg-blue-100 text-blue-800 p-3 rounded mb-3">
                <i class="ri-information-line mr-1"></i> <span th:text="${info}"></span>
            </div>
        </div>

        <!-- Page Title + Button -->
        <div class="px-6 py-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-gray-800">Chuyển kho</h1>
                <a sec:authorize="hasAnyRole('ADMIN','MANAGER','STAFF')"
                   th:href="@{/transfers/new}"
                   class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded inline-flex items-center">
                    <i class="ri-add-line mr-1"></i> Thêm phiếu chuyển
                </a>
            </div>

            <!-- Filter Bar (giống sale-orders) -->
            <form id="filterForm" method="get" class="mb-4 flex items-center gap-2">
                <input type="text" name="q" th:value="${q}" placeholder="Mã, Người tạo…"
                       class="border p-2 rounded w-60"/>

                <select name="status" class="border p-2 rounded" th:value="${status}">
                    <option value="" th:selected="${status == null or status == ''}">-- Trạng thái --</option>
                    <option th:value="DRAFT"      th:selected="${status == 'DRAFT'}">Nháp</option>
                    <option th:value="APPROVED"   th:selected="${status == 'APPROVED'}">Đã duyệt</option>
                    <option th:value="COMPLETED"  th:selected="${status == 'COMPLETED'}">Hoàn tất</option>
                    <option th:value="CANCELLED"  th:selected="${status == 'CANCELLED'}">Đã hủy</option>
                </select>

                <input type="datetime-local" name="from" class="border p-2 rounded"
                       th:value="${from != null ? #temporals.format(from, 'yyyy-MM-dd''T''HH:mm') : null}"/>

                <input type="datetime-local" name="to" class="border p-2 rounded"
                       th:value="${to != null ? #temporals.format(to, 'yyyy-MM-dd''T''HH:mm') : null}"/>

                <button type="submit" id="btnFilter" class="px-4 py-2 bg-blue-600 text-white rounded"
                        title="Nhấn lại lần nữa với bộ lọc y hệt để xóa lọc">Lọc</button>
            </form>

            <!-- Table card -->
            <div class="bg-white rounded-lg shadow">
                <table id="Table" class="min-w-full table-auto text-sm border border-gray-200">
                    <thead class="bg-gray-100 text-left">
                    <tr>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">STT</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">Mã phiếu</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">Từ kho</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">Đến kho</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">Số dòng</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">Ngày tạo</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap text-center">Trạng thái</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap text-center">Hành động</th>
                    </tr>
                    </thead>

                    <tbody>
                    <!-- Empty state -->
                    <tr th:if="${transfers == null or #lists.isEmpty(transfers)}">
                        <td colspan="8" class="px-4 py-6 text-center text-gray-500 italic">
                            Chưa có phiếu chuyển nào.
                        </td>
                    </tr>

                    <!-- Rows -->
                    <tr th:each="t, iStat : ${transfers}"
                        th:unless="${transfers == null or #lists.isEmpty(transfers)}"
                        class="border-t hover:bg-gray-100"
                        th:attr="data-od=${t.createdAt != null ? #temporals.format(t.createdAt, 'yyyyMMddHHmmss') : '00000000000000'},
                       data-id=${t.id}">
                        <td class="px-4 py-2 border border-gray-200 stt" th:text="${iStat.index + 1}"></td>
                        <td class="px-4 py-2 border border-gray-200 font-medium text-blue-600">
                            <a th:href="@{/transfers/{id}(id=${t.id})}" th:text="${t.code}">ST-202509-0001</a>
                        </td>
                        <td class="px-4 py-2 border border-gray-200" th:text="${t.fromWarehouseName}">Kho A</td>
                        <td class="px-4 py-2 border border-gray-200" th:text="${t.toWarehouseName}">Kho B</td>
                        <td class="px-4 py-2 border border-gray-200" th:text="${t.itemCount}">3</td>
                        <td class="px-4 py-2 border border-gray-200 whitespace-nowrap"
                            th:text="${#temporals.format(t.createdAt, 'dd/MM/yyyy HH:mm')}">21/09/2025 20:45</td>

                        <td class="px-4 py-2 border border-gray-200 w-36 text-center">
              <span class="inline-block w-full truncate px-2 py-1 rounded text-xs font-medium"
                    th:classappend="
                      ${t.status}=='CANCELLED'  ? 'bg-red-100 text-red-700' :
                      (${t.status}=='APPROVED'  ? 'bg-amber-100 text-amber-700' :
                      (${t.status}=='COMPLETED' ? 'bg-green-100 text-green-700' :
                      'bg-gray-100 text-gray-700'))"
                    th:text="${t.status}">
              </span>
                        </td>

                        <td class="px-4 py-2 border border-gray-200 text-center">
                            <div class="flex justify-center items-center space-x-2">
                                <a th:href="@{/transfers/{id}(id=${t.id})}"
                                   class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-100 text-gray-800 border rounded hover:bg-gray-200 text-sm shadow">
                                    <i class="ri-eye-line text-base"></i> Chi tiết
                                </a>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Phân trang (dùng chung fragment của bạn) -->
            <div th:replace="~{fragments/pagination :: clientPager('Table', 10)}"></div>
        </div>
    </main>
</div>

<!-- JS giống sale-orders: sort mới→cũ + auto-hide alerts -->
<script>
    (function () {
      var tbody = document.querySelector('#Table tbody');
      if (!tbody) return;
      var rows = Array.from(tbody.querySelectorAll('tr[data-od]'));
      rows.sort(function (a, b) {
        var ao = a.dataset.od || '0';
        var bo = b.dataset.od || '0';
        if (ao !== bo) return bo.localeCompare(ao);
        var ai = parseInt(a.dataset.id || '0', 10);
        var bi = parseInt(b.dataset.id || '0', 10);
        if (!isNaN(ai) && !isNaN(bi)) return bi - ai;
        return (b.dataset.id || '').localeCompare(a.dataset.id || '');
      });
      rows.forEach(function (r, idx) {
        tbody.appendChild(r);
        var sttCell = r.querySelector('td.stt');
        if (sttCell) sttCell.textContent = String(idx + 1);
      });
    })();

    (function () {
      var form = document.getElementById('filterForm');
      if (!form) return;
      var KEY = 'stockTransfers:lastQuery';
      function norm() {
        var fd = new FormData(form), p = new URLSearchParams();
        ['q','status','from','to'].forEach(function(n){
          var v = (fd.get(n)||'').toString().trim(); if(v) p.set(n,v);
        });
        return p.toString();
      }
      form.addEventListener('submit', function (e) {
        var current = norm(), last = sessionStorage.getItem(KEY);
        if (last && last === current) {
          e.preventDefault();
          ['q','from','to'].forEach(function(n){ var el=form.querySelector('[name="'+n+'"]'); if(el) el.value=''; });
          var sel=form.querySelector('[name="status"]'); if(sel) sel.value='';
          sessionStorage.removeItem(KEY);
          form.querySelectorAll('input,select').forEach(function(el){ if(!el.value) el.disabled=true; });
          form.submit();
        } else { sessionStorage.setItem(KEY, current); }
      });
    })();

    document.addEventListener("DOMContentLoaded", function () {
      const successAlert = document.getElementById('alertSuccess');
      const warningAlert = document.getElementById('alertWarning');
      [successAlert, warningAlert].forEach(a => { if (a) setTimeout(() => a.classList.add('hidden'), 3000); });
    });
</script>
</body>
</html>
