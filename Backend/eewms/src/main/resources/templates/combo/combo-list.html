<!-- src/main/resources/templates/combo/combo-list.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/common-head :: commonHead('Danh sách combo')}"></head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <main id="mainContent" class="flex-1 ml-64 transition-all duration-300 relative">
        <div th:replace="~{fragments/header :: header}"></div>

        <div class="flex justify-between items-center mb-4 px-6 py-6">
            <h1 class="text-2xl font-bold">Danh sách combo</h1>
            <div class="flex gap-2">
                <a th:href="@{/combos/create}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+
                    Thêm</a>
                <form th:action="@{/combos}" method="get" class="flex gap-2">
                    <input type="text" name="keyword" th:value="${keyword}" placeholder="Tìm theo tên hoặc mã..."
                           class="border px-3 py-2 rounded-md w-64"/>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tìm
                    </button>
                </form>
            </div>
        </div>
        <div class="px-6 pb-6">
            <div class="overflow-x-auto bg-white rounded-lg shadow">
                <table class="min-w-full text-sm text-left border border-gray-200">
                    <thead class="bg-gray-100 text-xs uppercase font-semibold">
                    <tr>
                        <th class="px-4 py-3 border border-gray-200">Code</th>
                        <th class="px-4 py-3 border border-gray-200">Tên combo</th>
                        <th class="px-4 py-3 border border-gray-200 w-[220px]">Trạng thái</th>
                        <th class="px-4 py-3 border border-gray-200">Mô tả</th>
                        <th class="px-4 py-3 border border-gray-200 text-center">Hành động</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="c : ${combos}" class="border-b hover:bg-gray-50"
                        th:data-id="${c.id}" th:data-status="${c.status}" th:data-name="${c.name}"
                        th:data-description="${c.description}">
                        <td class="px-4 py-3 border border-gray-200" th:text="${c.code}"></td>
                        <td class="px-4 py-3 border border-gray-200" th:text="${c.name}"></td>

                        <td class="px-4 py-3 border border-gray-200">
                            <div class="flex items-center gap-2">
                                <label class="inline-flex relative items-center cursor-pointer">
                                    <input type="checkbox"
                                           class="sr-only peer"
                                           th:checked="${c.status.name() == 'ACTIVE'}"
                                           th:data-id="${c.id}"
                                           onchange="toggleComboStatus(this)">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 transition duration-300"></div>
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition duration-200 transform peer-checked:translate-x-5"></div>
                                </label>
                                <span class="text-sm font-medium text-gray-700" data-label
                                      th:text="${c.status.name() == 'ACTIVE' ? 'Đang hoạt động' : 'Ngưng hoạt động'}">
                                </span>
                            </div>
                        </td>
                        <td class="px-4 py-3 border border-gray-200" th:text="${c.description} ?: '—'"></td>
                        <td class="px-4 py-2 text-center border border-gray-200 w-1">
                            <div class="flex items-center justify-center gap-3">
                                <a th:href="@{/combos/{id}/view(id=${c.id})}"
                                   class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-100 text-gray-800 border rounded hover:bg-gray-200"
                                   title="Xem">
                                    <i class="ri-eye-line"></i> Xem
                                </a>
                                <a th:href="@{/combos/{id}/edit(id=${c.id})}"
                                   class="inline-flex items-center gap-1 px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded"
                                   title="Sửa">
                                    <i class="ri-edit-line text-sm"></i> Sửa
                                </a>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="hidden" th:insert="~{fragments/footer :: footer}"></div>
    </main>
</div>
<script th:inline="javascript">
    function toggleComboStatus(checkbox) {
        const comboId = checkbox.dataset.id;
        const newStatus = checkbox.checked ? 'ACTIVE' : 'INACTIVE';

        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        fetch(`/combos/${comboId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({status: newStatus})
        })
            .then(res => res.ok ? res.text() : Promise.reject("Lỗi cập nhật"))
            .then(() => {
                const label = checkbox.closest("td").querySelector("[data-label]");
                if (label) label.innerText = newStatus === 'ACTIVE' ? 'Đang hoạt động' : 'Ngưng hoạt động';
                // cập nhật dataset của hàng (nếu bạn cần dùng ở nơi khác)
                checkbox.closest('tr').dataset.status = newStatus;
                if (window.toastSuccess) toastSuccess('Cập nhật trạng thái thành công');
            })
            .catch(() => {
                // rollback lại trạng thái checkbox -> peer-checked cũng tự rollback
                checkbox.checked = !checkbox.checked;
                if (window.toastError) toastError('Cập nhật trạng thái thất bại');
            });
    }
</script>
</body>
</html>
