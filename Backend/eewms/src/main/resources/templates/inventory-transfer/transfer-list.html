<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/common-head :: commonHead('Chuyển kho')}"></head>

<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- Main content -->
    <main id="mainContent" class="flex-1 ml-64 transition-all duration-300 relative">
        <!-- Header -->
        <div th:replace="~{fragments/header :: header}"></div>

        <!-- Flash/Toast zone -->
        <div class="flex justify-between items-center mb-4 px-4 py-4">
            <div th:if="${success}" id="alertSuccess" class="mb-4 bg-green-100 text-green-800 px-4 py-2 rounded">
                <p th:text="${success}"></p>
            </div>
            <div th:if="${error}" class="bg-red-100 text-red-700 px-4 py-2 rounded mb-4">
                <i class="ri-error-warning-line mr-1"></i> <span th:text="${error}"></span>
            </div>
            <div th:if="${warning}" id="alertWarning"
                 class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded mb-4 border-l-4 border-yellow-500 shadow">
                <i class="ri-alert-line mr-1"></i> <span th:text="${warning}"></span>
            </div>
            <div th:if="${info}" class="bg-blue-100 text-blue-800 p-3 rounded mb-3">
                <i class="ri-information-line mr-1"></i> <span th:text="${info}"></span>
            </div>
        </div>

        <!-- Page Title + Button -->
        <div class="px-6 py-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-gray-800">Chuyển kho</h1>
                <a sec:authorize="hasAnyRole('ADMIN','MANAGER','STAFF')"
                   th:href="@{/inventory-transfers/new}"
                   class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded inline-flex items-center">
                    <i class="ri-add-line mr-1"></i> Tạo phiếu chuyển kho
                </a>
            </div>

            <!-- Filter Bar -->
            <form id="filterForm" method="get" class="mb-4 grid grid-cols-1 md:grid-cols-6 gap-2">
                <input type="text" name="keyword" th:value="${keyword}" placeholder="Mã / Ghi chú"
                       class="border p-2 rounded w-full"/>

                <!-- Status -->
                <select name="status" class="border p-2 rounded">
                    <option value="" th:selected="${statusFilter == null}">-- Trạng thái --</option>
                    <option th:each="st : ${allStatuses}"
                            th:value="${st}"
                            th:selected="${statusFilter == st}"
                            th:text="${st.label}">Status
                    </option>
                </select>

                <!-- From warehouse -->
                <select name="fromWarehouseId" class="border p-2 rounded">
                    <option value="" th:selected="${fromWarehouseId == null}">-- Kho nguồn --</option>
                    <option th:each="w: ${allWarehouses}"
                            th:value="${w.id}"
                            th:selected="${fromWarehouseId == w.id}"
                            th:text="${w.name}">Kho
                    </option>
                </select>

                <!-- To warehouse -->
                <select name="toWarehouseId" class="border p-2 rounded">
                    <option value="" th:selected="${toWarehouseId == null}">-- Kho đích --</option>
                    <option th:each="w: ${allWarehouses}"
                            th:value="${w.id}"
                            th:selected="${toWarehouseId == w.id}"
                            th:text="${w.name}">Kho
                    </option>
                </select>

                <input type="datetime-local" name="fromDate" class="border p-2 rounded"
                       th:value="${fromDate != null ? #temporals.format(fromDate, 'yyyy-MM-dd''T''HH:mm') : null}"/>
                <input type="datetime-local" name="toDate" class="border p-2 rounded"
                       th:value="${toDate != null ? #temporals.format(toDate, 'yyyy-MM-dd''T''HH:mm') : null}"/>

                <div class="md:col-span-6">
                    <button type="submit" id="btnFilter" class="px-4 py-2 bg-blue-600 text-white rounded">
                        Lọc
                    </button>
                </div>
            </form>

            <!-- Table card -->
            <div class="bg-white rounded-lg shadow">
                <table id="Table" class="min-w-full table-auto text-sm border border-gray-200">
                    <thead class="bg-gray-100 text-left">
                    <tr>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">STT</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">Mã phiếu</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">Từ kho</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">Đến kho</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">Số sản phẩm</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap">Ngày tạo</th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap text-center">Trạng
                            thái
                        </th>
                        <th class="px-4 py-3 font-semibold border border-gray-200 whitespace-nowrap text-center">Hành
                            động
                        </th>
                    </tr>
                    </thead>

                    <tbody>
                    <!-- Empty state -->
                    <tr th:if="${page == null or #lists.isEmpty(page.content)}">
                        <td colspan="8" class="px-4 py-6 text-center text-gray-500 italic">
                            Chưa có phiếu chuyển nào.
                        </td>
                    </tr>

                    <!-- Rows -->
                    <tr th:each="t, iStat : ${page.content}"
                        th:unless="${page == null or #lists.isEmpty(page.content)}"
                        class="border-t hover:bg-gray-100"
                        th:attr="data-od=${t.createdAt != null ? #temporals.format(t.createdAt, 'yyyyMMddHHmmss') : '00000000000000'},
                                 data-id=${t.id}">
                        <td class="px-4 py-2 border border-gray-200 stt" th:text="${iStat.index + 1}"></td>
                        <td class="px-4 py-2 border border-gray-200 font-medium text-blue-600">
                            <a th:href="@{/inventory-transfers/{id}(id=${t.id})}" th:text="${t.code}">TRF-XX</a>
                        </td>
                        <td class="px-4 py-2 border border-gray-200"
                            th:text="${t.fromWarehouse != null ? t.fromWarehouse.name : ''}">Kho A
                        </td>
                        <td class="px-4 py-2 border border-gray-200"
                            th:text="${t.toWarehouse != null ? t.toWarehouse.name : ''}">Kho B
                        </td>
                        <td class="px-4 py-2 border border-gray-200"><span th:text="${t.itemCount}">0</span>

                        </td>
                        <td class="px-4 py-2 border border-gray-200 whitespace-nowrap"
                            th:text="${#temporals.format(t.createdAt, 'dd/MM/yyyy HH:mm')}">21/09/2025 20:45
                        </td>

                        <td class="px-4 py-2 border border-gray-200 w-40 text-center">
                          <span class="inline-block w-full truncate px-2 py-1 rounded text-xs font-medium"
                                th:classappend="
                                  ${t.status.name()}=='CANCELED'     ? 'bg-red-100 text-red-700' :
                                  (${t.status.name()}=='IMPORTED'    ? 'bg-green-100 text-green-700' :
                                  (${t.status.name()}=='EXPORTED'    ? 'bg-emerald-100 text-emerald-700' :
                                  (${t.status.name()}=='TO_APPROVED' ? 'bg-amber-100 text-amber-700' :
                                  (${t.status.name()}=='FROM_APPROVED' ? 'bg-yellow-100 text-yellow-700' :
                                  'bg-gray-100 text-gray-700'))))"
                                th:text="${t.status.label}">
                          </span>
                        </td>

                        <td class="px-4 py-2 border border-gray-200 text-center">
                            <div class="flex justify-center items-center space-x-2">
                                <a th:href="@{/inventory-transfers/{id}(id=${t.id})}"
                                   class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-100 text-gray-800 border rounded hover:bg-gray-200 text-sm shadow">
                                    <i class="ri-eye-line text-base"></i> Chi tiết
                                </a>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Phân trang -->
            <div class="mt-4" th:replace="~{fragments/pagination :: clientPager('Table', 10)}"></div>
        </div>
    </main>
</div>

<!-- JS: sort mới→cũ + auto-hide alerts -->
<script>
    (function () {
        var tbody = document.querySelector('#Table tbody');
        if (!tbody) return;
        var rows = Array.from(tbody.querySelectorAll('tr[data-od]'));
        rows.sort(function (a, b) {
            var ao = a.dataset.od || '0';
            var bo = b.dataset.od || '0';
            if (ao !== bo) return bo.localeCompare(ao);
            var ai = parseInt(a.dataset.id || '0', 10);
            var bi = parseInt(b.dataset.id || '0', 10);
            if (!isNaN(ai) && !isNaN(bi)) return bi - ai;
            return (b.dataset.id || '').localeCompare(a.dataset.id || '');
        });
        rows.forEach(function (r, idx) {
            tbody.appendChild(r);
            var sttCell = r.querySelector('td.stt');
            if (sttCell) sttCell.textContent = String(idx + 1);
        });
    })();

    document.addEventListener("DOMContentLoaded", function () {
        const successAlert = document.getElementById('alertSuccess');
        const warningAlert = document.getElementById('alertWarning');
        [successAlert, warningAlert].forEach(a => {
            if (a) setTimeout(() => a?.classList.add('hidden'), 3000);
        });
    });
</script>
</body>
</html>
