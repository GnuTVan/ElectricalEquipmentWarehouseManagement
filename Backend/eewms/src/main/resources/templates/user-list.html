<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{fragments/common-head :: commonHead('Danh s√°ch ng∆∞·ªùi d√πng')}"></head>
<body class="bg-gray-100 font-sans">
<div class="flex h-screen">
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- Main content -->
    <main id="mainContent" class="flex-1 ml-64 transition-all duration-300 relative">
        <!-- Header -->
        <div th:replace="~{fragments/header :: header}"></div>

        <div class="flex justify-between items-center mb-6 p-6">
            <h1 class="text-2xl font-bold text-gray-800">Danh s√°ch ng∆∞·ªùi d√πng</h1>
            <div class="flex items-center space-x-2">
                <!-- üîë Nh·∫•n + Th√™m s·∫Ω reset form & xo√° l·ªói c≈© -->
                <a onclick="openModal(false)"
                   class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 cursor-pointer">+ Th√™m</a>

                <form th:action="@{/admin/users}" method="get" class="flex gap-2">
                    <input type="text" name="keyword" th:value="${keyword}" placeholder="T√¨m ki·∫øm..."
                           class="border px-3 py-2 rounded-md w-64"/>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">T√¨m
                    </button>
                </form>
            </div>
        </div>

        <div th:if="${message}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-2 rounded mb-4">
            <p th:text="${message}"></p>
        </div>
        <div th:if="${error}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4">
            <p th:text="${error}"></p>
        </div>
        <div class="px-6 py-6">
            <!-- Table -->
            <div class="bg-white shadow-md rounded-lg">
                <table id="Table" class="min-w-full table-auto text-sm text-left border border-gray-200">
                    <thead class="bg-gray-100 text-gray-700 font-semibold">
                    <tr>
                        <th class="px-4 py-3 border border-gray-200 whitespace-nowrap text-left">ID</th>
                        <th class="px-4 py-3 border border-gray-200 whitespace-nowrap text-left">H·ªç v√† t√™n</th>
                        <th class="px-4 py-3 border border-gray-200 whitespace-nowrap text-left">T√™n t√†i kho·∫£n</th>
                        <th class="px-4 py-3 border border-gray-200 whitespace-nowrap text-left">Email</th>
                        <th class="px-4 py-3 border border-gray-200 whitespace-nowrap text-left">SƒêT</th>
                        <th class="px-4 py-3 border border-gray-200 whitespace-nowrap text-left">ƒê·ªãa ch·ªâ</th>
                        <th class="px-4 py-3 border border-gray-200 whitespace-nowrap text-center">Ch·ª©c v·ª•</th>
                        <th class="px-4 py-3 border border-gray-200 whitespace-nowrap text-center">Tr·∫°ng th√°i</th>
                        <th class="px-4 py-3 border border-gray-200 whitespace-nowrap text-center">H√†nh ƒë·ªông</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="user : ${users}" class="border-b hover:bg-gray-50"
                        th:data-id="${user.id}"
                        th:data-username="${user.username}"
                        th:data-fullname="${user.fullName}"
                        th:data-email="${user.email}"
                        th:data-address="${user.address}"
                        th:data-phone="${user.phone}"
                        th:data-role="${user.roleIds[0]}">
                        <td class="px-4 py-3 border border-gray-200" th:text="${user.id}"></td>
                        <td class="px-4 py-3 border border-gray-200" th:text="${user.fullName}"></td>
                        <td class="px-4 py-3 border border-gray-200" th:text="${user.username}"></td>
                        <td class="px-4 py-3 border border-gray-200" th:text="${user.email}"></td>
                        <td class="px-4 py-3 border border-gray-200" th:text="${user.phone}"></td>
                        <td class="px-4 py-3 border border-gray-200" th:text="${user.address}"></td>
                        <td class="px-4 py-3 border border-gray-200 text-center whitespace-nowrap w-1">
  <span th:each="role : ${user.roleNames}" class="inline-block mr-1">
    <span th:switch="${role}" class="text-sm font-medium">
      <span th:case="'ADMIN'" class="inline-block px-2 py-1 rounded bg-red-100 text-red-700">Qu·∫£n tr·ªã vi√™n</span>
      <span th:case="'MANAGER'" class="inline-block px-2 py-1 rounded bg-yellow-100 text-yellow-700">Qu·∫£n l√Ω</span>
      <span th:case="'STAFF'" class="inline-block px-2 py-1 rounded bg-blue-100 text-blue-700">Nh√¢n vi√™n</span>
      <span th:case="*" class="bg-green-100 text-green-700" th:text="${role}"></span>
    </span>
  </span>
                        </td>

                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <label class="inline-flex relative items-center cursor-pointer">
                                    <input type="checkbox" th:checked="${user.enabled}"
                                           th:data-id="${user.id}" class="sr-only peer"
                                           onchange="toggleUserStatus(this, event)">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-green-500 transition duration-300"></div>
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition duration-200 transform peer-checked:translate-x-5"></div>
                                </label>
                                <span class="text-sm font-medium text-gray-700 min-w-[120px] inline-block"
                                      th:text="${user.enabled ? 'ƒêang ho·∫°t ƒë·ªông' : 'Ng∆∞ng ho·∫°t ƒë·ªông'}"></span>
                            </div>
                        </td>
                        <td class="px-4 py-3 border border-gray-200 text-center">
                            <form th:action="@{/admin/users/reset-password/{id}(id=${user.id})}" method="post">
                                <button type="submit"
                                        onclick="return confirm('B·∫°n c√≥ mu·ªën ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u cho ng∆∞·ªùi d√πng n√†y?')"
                                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm font-medium whitespace-nowrap shadow">
                                    ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div th:replace="~{fragments/pagination :: clientPager('Table', 10)}"></div>
        </div>

        <!-- Modal Th√™m User -->
        <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white w-full max-w-md rounded shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Th√™m ng∆∞·ªùi d√πng</h2>
                    <button type="button" onclick="closeModal()"><i class="ri-close-line text-2xl"></i></button>
                </div>

                <form th:action="@{/admin/users}" th:object="${userDTO}" method="post">
                    <!-- H·ªç t√™n -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium">H·ªç t√™n</label>
                        <input type="text" th:field="*{fullName}" class="w-full border rounded px-3 py-2"/>
                        <p th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}"
                           class="text-red-600 text-sm mt-1 server-error"></p>
                    </div>

                    <!-- T√™n ƒëƒÉng nh·∫≠p -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium">T√™n ƒëƒÉng nh·∫≠p</label>
                        <input type="text" th:field="*{username}" class="w-full border rounded px-3 py-2"/>
                        <p th:if="${#fields.hasErrors('username')}" th:errors="*{username}"
                           class="text-red-600 text-sm mt-1 server-error"></p>
                    </div>

                    <!-- Email -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium">Email</label>
                        <input type="email" th:field="*{email}" class="w-full border rounded px-3 py-2"/>
                        <p th:if="${#fields.hasErrors('email')}" th:errors="*{email}"
                           class="text-red-600 text-sm mt-1 server-error"></p>
                    </div>

                    <!-- Ch·ª©c v·ª• -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium">Ch·ª©c v·ª•</label>
                        <select th:field="*{roleIds}" class="w-full border rounded px-3 py-2">
                            <option th:each="role : ${allRoles}" th:value="${role.id}"
                                    th:with="code=${#strings.replace(role.name,'ROLE_','')}"
                                    th:text="${code == 'ADMIN' ? 'Qu·∫£n tr·ªã vi√™n'
                   : (code == 'MANAGER' ? 'Qu·∫£n l√Ω'
                   : (code == 'STAFF' ? 'Nh√¢n vi√™n' : code))}"></option>
                        </select>
                        <p th:if="${#fields.hasErrors('roleIds')}" th:errors="*{roleIds}"
                           class="text-red-600 text-sm mt-1 server-error"></p>
                    </div>

                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded">
                            H·ªßy
                        </button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- C·∫Øm c·ªù ƒë·ªÉ JS bi·∫øt c√≥ l·ªói/ c·∫ßn m·ªü modal -->
        <div id="userModalFlag"
             th:attr="data-has-errors=${hasValidationErrors}"></div>

    </main>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- JS -->
<script th:inline="javascript">
    /** X√≥a s·∫°ch d·ªØ li·ªáu & l·ªói trong form t·∫°o user (hard reset) */
    function clearCreateForm() {
        const modal = document.getElementById('userModal');
        if (!modal) return;
        const form = modal.querySelector('form');
        if (!form) return;

        // X√≥a c√°c input text/email/tel/textarea
        form.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], textarea')
            .forEach(el => {
                el.value = '';
                el.removeAttribute('value'); // ngƒÉn DOM c≈© gi·ªØ l·∫°i
            });

        // Reset select roleIds v·ªÅ option ƒë·∫ßu
        const roleSelect = form.querySelector('select[name="roleIds"]');
        if (roleSelect) roleSelect.selectedIndex = 0;

        // X√≥a th√¥ng b√°o l·ªói render b·ªüi Thymeleaf
        form.querySelectorAll('.server-error').forEach(el => el.textContent = '');
    }

    /** M·ªü modal
     * @param {boolean} reset - true: m·ªü m·ªõi tinh, false: gi·ªØ d·ªØ li·ªáu (d√πng cho case validate fail)
     */
    function openModal(reset = false) {
        const modal = document.getElementById('userModal');
        if (!modal) return;
        if (reset) clearCreateForm();      // b·∫•m +Th√™m ‚Üí m·ªü tr·∫Øng
        modal.classList.remove('hidden');
    }

    /** ƒê√≥ng modal + chu·∫©n b·ªã l·∫ßn m·ªü sau l√† form tr·∫Øng */
    function closeModal() {
        const modal = document.getElementById('userModal');
        if (modal) {
            modal.classList.add('hidden');
            clearCreateForm();               // ƒë√≥ng l·∫°i l√† d·ªçn form
        }
    }

    /** Toggle tr·∫°ng th√°i user */
    function toggleUserStatus(checkbox, event) {
        event.preventDefault();

        const userId = checkbox.dataset.id;
        const newStatus = checkbox.checked;

        // CSRF (n·∫øu c√≥ Spring Security)
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        const headers = {'Content-Type': 'application/json'};
        if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

        fetch(`/admin/users/${userId}/toggle-status`, {
            method: 'POST',
            headers,
            body: JSON.stringify({enabled: newStatus})
        })
            .then(res => res.ok ? res.text() : Promise.reject("L·ªói c·∫≠p nh·∫≠t"))
            .then(() => {
                const label = checkbox.closest("td").querySelector("span");
                label.innerText = newStatus ? "ƒêang ho·∫°t ƒë·ªông" : "Ng∆∞ng ho·∫°t ƒë·ªông";
                checkbox.checked = newStatus;
            })
            .catch(() => {
                checkbox.checked = !newStatus;
                alert("C·∫≠p nh·∫≠t tr·∫°ng th√°i th·∫•t b·∫°i.");
            });
    }

    /** Auto-open modal khi c√≥ l·ªói validate t·ª´ server */
    document.addEventListener('DOMContentLoaded', function () {
        const flagEl = document.getElementById('userModalFlag'); // <div id="userModalFlag" data-has-errors="true|false">
        const hasErrorsFlag = flagEl ? (flagEl.dataset.hasErrors === 'true') : false;
        const shouldOpen = /*[[${openCreateModal}]]*/ false;     // boolean t·ª´ Controller

        if (hasErrorsFlag || shouldOpen) {
            // Gi·ªØ nguy√™n d·ªØ li·ªáu ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y l·ªói v√† s·ª≠a
            openModal(false);
        }
    });

    /** UX: nh·∫•n ESC ƒë·ªÉ ƒë√≥ng modal v√† clear form */
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeModal();
    });
</script>

</body>
</html>
